<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Couch Funds | Build Wealth Without Leaving Your Couch üõãÔ∏èüí∞</title>

  <meta name="description" content="Build wealth without the hustle. Get daily money tips, play games, and unlock secret AI side hustles. The anti-grind finance community.">
  <meta name="keywords" content="passive income, side hustles, AI money making, financial tips, wealth building, couch potato millionaire">
  <meta name="author" content="Couch Funds">

  <meta property="og:title" content="Couch Funds | Build Wealth. Stay Horizontal.">
  <meta property="og:description" content="I just unlocked secret side hustles on Couch Funds! üõãÔ∏èüí∞ Beat the AI and learn how to make money online.">
  <meta property="og:image" content="https://placehold.co/1200x630/022c22/fbbf24/png?text=Couch+Funds&font=raleway">
  <meta property="og:image:width" content="1200">
  <meta property="og:image:height" content="630">
  <meta property="og:image:type" content="image/png">
  <meta property="og:url" content="https://shungtai.com">
  <meta property="og:type" content="website">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="Couch Funds | Build Wealth. Stay Horizontal.">
  <meta name="twitter:description" content="Beat the AI and unlock secret side hustles. The anti-grind finance community.">
  <meta name="twitter:image" content="https://placehold.co/1200x630/022c22/fbbf24/png?text=Couch+Funds&font=raleway">

  <link rel="canonical" href="https://shungtai.com">
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;600;800&family=Space+Grotesk:wght@400;700&family=Share+Tech+Mono&display=swap" rel="stylesheet">

  <!-- Google Analytics (REPLACE G-XXXXXXXXXX with your Measurement ID) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-XXXXXXXXXX"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-XXXXXXXXXX', { 'send_page_view': true });

    // Custom event tracking function
    window.trackEvent = function(category, action, label) {
      if (typeof gtag !== 'undefined') {
        gtag('event', action, {
          'event_category': category,
          'event_label': label
        });
      }
    };
  </script>

  <style>
    :root {
      --bg-deep: #022c22;
      --bg-glass: rgba(255, 255, 255, 0.03);
      --bg-glass-hover: rgba(255, 255, 255, 0.08);
      --border-glass: rgba(255, 255, 255, 0.1);
      --accent-gold: #fbbf24;
      --accent-green: #34d399;
      --accent-red: #f87171;
      --accent-purple: #a78bfa;
      --text-main: #ecfdf5;
      --text-muted: #6ee7b7;
      --fb-blue: #4267B2;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; user-select: none; -webkit-user-select: none; }

    body {
      background-color: var(--bg-deep);
      color: var(--text-main);
      font-family: 'Space Grotesk', sans-serif;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      overflow-x: hidden;
      position: relative;
      padding-bottom: 80px;
    }

    #loading-screen {
      position: fixed;
      inset: 0;
      background: var(--bg-deep);
      z-index: 9999;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      gap: 12px;
      transition: opacity 0.5s ease;
    }

    #loading-screen .icon { font-size: 3.2rem; }
    #loading-screen .title {
      color: var(--accent-gold);
      font-family: 'Outfit', sans-serif;
      font-size: 2rem;
      font-weight: 900;
      letter-spacing: 1px;
    }
    #loading-screen .sub {
      color: var(--text-muted);
      font-size: 0.95rem;
    }

    .orb {
      position: absolute;
      border-radius: 50%;
      filter: blur(80px);
      z-index: -1;
      opacity: 0.4;
      animation: float 20s infinite alternate;
    }
    .orb-1 { top: -10%; left: -10%; width: 50vw; height: 50vw; background: var(--accent-green); }
    .orb-2 { bottom: -10%; right: -10%; width: 40vw; height: 40vw; background: #065f46; animation-delay: -5s; }

    @keyframes float {
      0% { transform: translate(0, 0); }
      100% { transform: translate(30px, 50px); }
    }

    .container {
      width: 90%;
      max-width: 800px;
      text-align: center;
      z-index: 1;
      padding-top: 60px;
    }

    .brand {
      font-family: 'Outfit', sans-serif;
      font-weight: 800;
      font-size: 1.5rem;
      letter-spacing: 2px;
      color: var(--accent-gold);
      margin-bottom: 0.6rem;
      text-transform: uppercase;
      opacity: 0.9;
    }

    .fb-hero {
      width: 100%;
      max-width: 800px;
      margin: 0 auto 1.2rem;
      padding: 12px 14px;
      border-radius: 16px;
      border: 1px solid rgba(66, 103, 178, 0.35);
      background: linear-gradient(135deg, rgba(66, 103, 178, 0.18), rgba(255, 255, 255, 0.03));
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      flex-wrap: wrap;
    }

    .fb-hero-left {
      display: flex;
      align-items: center;
      gap: 10px;
      text-align: left;
      flex: 1;
      min-width: 260px;
    }

    .fb-badge {
      width: 42px;
      height: 42px;
      border-radius: 12px;
      background: rgba(66, 103, 178, 0.25);
      border: 1px solid rgba(66, 103, 178, 0.45);
      display: grid;
      place-items: center;
      font-weight: 900;
      font-family: 'Outfit', sans-serif;
    }

    .fb-hero-title {
      font-family: 'Outfit', sans-serif;
      font-weight: 800;
      font-size: 1.05rem;
      line-height: 1.2;
      color: #eaf2ff;
    }

    .fb-hero-sub {
      font-size: 0.85rem;
      color: rgba(236, 253, 245, 0.75);
      margin-top: 2px;
    }

    .fb-hero-actions {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .fb-primary-btn {
      background: rgba(66, 103, 178, 0.18);
      border: 1px solid rgba(66, 103, 178, 0.5);
      color: #eaf2ff;
      padding: 10px 16px;
      border-radius: 999px;
      font-size: 0.9rem;
      font-weight: 800;
      cursor: pointer;
      transition: 0.25s;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      font-family: 'Space Grotesk', sans-serif;
      white-space: nowrap;
    }

    .fb-primary-btn:hover {
      transform: translateY(-2px);
      background: rgba(66, 103, 178, 0.35);
      box-shadow: 0 10px 24px rgba(0,0,0,0.25);
    }

    .fb-primary-btn:active { transform: translateY(0); }

    .floating-fb {
      position: fixed;
      top: 50%;
      transform: translateY(-50%);
      right: 18px;
      z-index: 60;
      display: flex;
      flex-direction: column;
      gap: 10px;
      align-items: flex-end;
      pointer-events: none;
    }

    .floating-fb a,
    .floating-fb button {
      pointer-events: auto;
    }

    .floating-fb-pill {
      background: rgba(66, 103, 178, 0.18);
      border: 1px solid rgba(66, 103, 178, 0.45);
      color: #eaf2ff;
      padding: 10px 14px;
      border-radius: 999px;
      display: inline-flex;
      align-items: center;
      gap: 10px;
      cursor: pointer;
      transition: 0.25s;
      font-family: 'Outfit', sans-serif;
      font-weight: 800;
      text-decoration: none;
      box-shadow: 0 12px 30px rgba(0,0,0,0.25);
      max-width: 260px;
    }

    .floating-fb-pill:hover {
      transform: translateY(-2px);
      background: rgba(66, 103, 178, 0.32);
    }

    .floating-fb-icon {
      width: 32px;
      height: 32px;
      border-radius: 10px;
      background: rgba(66, 103, 178, 0.35);
      display: grid;
      place-items: center;
      border: 1px solid rgba(66, 103, 178, 0.6);
      font-weight: 900;
    }

    .floating-fb-text {
      display: flex;
      flex-direction: column;
      line-height: 1.05;
      text-align: left;
    }

    .floating-fb-text small {
      font-family: 'Space Grotesk', sans-serif;
      font-weight: 700;
      opacity: 0.85;
      font-size: 0.75rem;
    }

    /* =========================
       REFERRAL BADGE (NEW)
       ========================= */
    .referral-badge {
      background: linear-gradient(135deg, rgba(167, 139, 250, 0.15), rgba(52, 211, 153, 0.1));
      border: 1px solid var(--accent-purple);
      border-radius: 15px;
      padding: 12px 16px;
      margin: 0 auto 1.5rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      flex-wrap: wrap;
      max-width: 800px;
    }

    .referral-badge .left {
      display: flex;
      align-items: center;
      gap: 10px;
      min-width: 260px;
    }

    .referral-badge .icon {
      font-size: 1.8rem;
    }

    .referral-badge .text {
      text-align: left;
    }

    .referral-badge .title {
      font-family: 'Outfit', sans-serif;
      font-weight: 800;
      font-size: 0.95rem;
      color: var(--accent-purple);
    }

    .referral-badge .count {
      font-size: 0.8rem;
      color: var(--text-muted);
      margin-top: 2px;
    }

    .referral-btn {
      background: transparent;
      border: 1px solid var(--accent-purple);
      color: var(--accent-purple);
      padding: 8px 18px;
      border-radius: 50px;
      font-size: 0.85rem;
      font-weight: 800;
      cursor: pointer;
      transition: all 0.3s ease;
      font-family: 'Space Grotesk', sans-serif;
      white-space: nowrap;
    }

    .referral-btn:hover {
      background: var(--accent-purple);
      color: var(--bg-deep);
      transform: translateY(-2px);
    }

    .achievements-bar {
      display: flex;
      gap: 10px;
      justify-content: center;
      flex-wrap: wrap;
      margin-bottom: 1rem;
    }

    .achievement-badge {
      background: var(--bg-glass);
      border: 1px solid var(--border-glass);
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 0.85rem;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: all 0.3s ease;
    }

    .achievement-badge.unlocked {
      border-color: var(--accent-gold);
      background: rgba(251, 191, 36, 0.1);
      animation: badgeUnlock 0.5s ease;
    }

    .achievement-badge.locked {
      opacity: 0.3;
      filter: grayscale(1);
    }

    @keyframes badgeUnlock {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.2); }
    }

    .streak-display {
      background: linear-gradient(135deg, rgba(251, 191, 36, 0.1), rgba(52, 211, 153, 0.1));
      border: 1px solid var(--accent-gold);
      border-radius: 15px;
      padding: 15px;
      margin-bottom: 2rem;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 15px;
    }

    .streak-flame {
      font-size: 2rem;
      animation: flicker 2s infinite;
    }

    @keyframes flicker {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.8; transform: scale(1.1); }
    }

    .streak-text {
      font-family: 'Outfit', sans-serif;
      font-weight: 700;
      font-size: 1.2rem;
    }

    .streak-subtitle {
      font-size: 0.8rem;
      color: var(--text-muted);
      margin-top: 3px;
    }

    .leaderboard-section {
      background: var(--bg-glass);
      backdrop-filter: blur(20px);
      border: 1px solid var(--border-glass);
      border-radius: 20px;
      padding: 2rem;
      margin-bottom: 2rem;
    }

    /* =========================
       LEADERBOARD TABS (NEW)
       ========================= */
    .leaderboard-tabs {
      display: flex;
      gap: 10px;
      justify-content: center;
      margin-bottom: 1.5rem;
      flex-wrap: wrap;
    }

    .leaderboard-load-wrap {
      display: flex;
      justify-content: center;
      margin-bottom: 1rem;
    }

    .leaderboard-load-btn {
      background: transparent;
      border: 1px solid var(--accent-green);
      color: var(--accent-green);
      padding: 8px 18px;
      border-radius: 999px;
      font-size: 0.85rem;
      font-weight: 800;
      cursor: pointer;
      transition: all 0.25s ease;
      font-family: 'Space Grotesk', sans-serif;
    }

    .leaderboard-load-btn:hover:not(:disabled) {
      background: rgba(52, 211, 153, 0.12);
      transform: translateY(-1px);
    }

    .leaderboard-load-btn:disabled {
      opacity: 0.55;
      cursor: not-allowed;
    }

    .leaderboard-tab {
      background: transparent;
      border: 1px solid var(--border-glass);
      color: var(--text-muted);
      padding: 8px 20px;
      border-radius: 50px;
      font-size: 0.85rem;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s ease;
      font-family: 'Space Grotesk', sans-serif;
    }

    .leaderboard-tab.active {
      border-color: var(--accent-gold);
      background: rgba(251, 191, 36, 0.1);
      color: var(--accent-gold);
    }

    .leaderboard-tab:hover:not(.active) {
      border-color: var(--accent-green);
      background: rgba(52, 211, 153, 0.05);
    }

    .leaderboard-title {
      font-family: 'Outfit', sans-serif;
      font-size: 1.3rem;
      font-weight: 700;
      color: var(--accent-gold);
      margin-bottom: 1.2rem;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }

    .leaderboard-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .leaderboard-item {
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid rgba(255, 255, 255, 0.05);
      border-radius: 10px;
      padding: 12px 15px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: 0.2s;
    }

    .leaderboard-item:hover {
      background: rgba(255, 255, 255, 0.05);
      border-color: var(--accent-green);
    }

    .leaderboard-item.you {
      border-color: var(--accent-gold);
      background: rgba(251, 191, 36, 0.1);
    }

    .leaderboard-rank {
      font-weight: 800;
      font-size: 1.2rem;
      color: var(--accent-green);
      min-width: 40px;
    }

    .leaderboard-rank.gold { color: #fbbf24; }
    .leaderboard-rank.silver { color: #94a3b8; }
    .leaderboard-rank.bronze { color: #fb923c; }

    .leaderboard-name {
      flex: 1;
      text-align: left;
      font-weight: 600;
    }

    .leaderboard-balance {
      color: var(--accent-green);
      font-weight: 700;
    }

    .social-share-bar {
      display: flex;
      gap: 10px;
      justify-content: center;
      margin-top: 1.2rem;
      flex-wrap: wrap;
    }

    .share-btn {
      background: var(--bg-glass);
      border: 1px solid var(--border-glass);
      color: var(--text-main);
      padding: 10px 20px;
      border-radius: 50px;
      font-size: 0.85rem;
      font-weight: 800;
      cursor: pointer;
      transition: all 0.3s ease;
      font-family: 'Space Grotesk', sans-serif;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      white-space: nowrap;
    }

    .share-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    }

    .share-btn.facebook { border-color: var(--fb-blue); }
    .share-btn.facebook:hover { background: var(--fb-blue); color: white; }

    .share-btn.twitter { border-color: #1DA1F2; }
    .share-btn.twitter:hover { background: #1DA1F2; color: white; }

    .share-btn.whatsapp { border-color: #25D366; }
    .share-btn.whatsapp:hover { background: #25D366; color: white; }

    .share-btn.copy { border-color: rgba(251, 191, 36, 0.7); }
    .share-btn.copy:hover { background: rgba(251, 191, 36, 0.18); border-color: var(--accent-gold); }

    .fb-prominent {
      margin-top: 14px;
      padding: 14px;
      border-radius: 16px;
      border: 1px solid rgba(66, 103, 178, 0.35);
      background: rgba(66, 103, 178, 0.12);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      flex-wrap: wrap;
    }

    .fb-prominent .left {
      text-align: left;
      flex: 1;
      min-width: 240px;
    }

    .fb-prominent .left .title {
      font-family: 'Outfit', sans-serif;
      font-weight: 900;
      color: #eaf2ff;
      margin-bottom: 2px;
      font-size: 1rem;
    }

    .fb-prominent .left .sub {
      font-size: 0.85rem;
      color: rgba(236, 253, 245, 0.75);
      line-height: 1.25;
    }

    .tip-card {
      background: var(--bg-glass);
      backdrop-filter: blur(20px);
      border: 1px solid var(--border-glass);
      border-radius: 30px;
      padding: 3rem 2rem;
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
      margin-bottom: 3rem;
      position: relative;
      overflow: hidden;
    }

    .tip-label {
      font-family: 'Outfit', sans-serif;
      font-size: 0.8rem;
      text-transform: uppercase;
      letter-spacing: 3px;
      color: var(--accent-green);
      margin-bottom: 1rem;
      display: block;
    }

    .tip-content {
      font-family: 'Outfit', sans-serif;
      font-size: clamp(1.2rem, 3vw, 1.8rem);
      font-weight: 600;
      line-height: 1.4;
      min-height: 80px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .btn-shuffle {
      background: transparent;
      border: 1px solid var(--accent-green);
      color: var(--accent-green);
      padding: 10px 30px;
      border-radius: 50px;
      font-size: 0.9rem;
      font-weight: 800;
      cursor: pointer;
      transition: all 0.3s ease;
      font-family: 'Space Grotesk', sans-serif;
      margin-top: 1.5rem;
    }
    .btn-shuffle:hover { background: var(--accent-green); color: var(--bg-deep); transform: translateY(-2px); }
    .btn-shuffle:active { transform: translateY(0); }

    #ttt-board {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      max-width: 260px;
      margin: 20px auto;
    }
    .ttt-cell {
      aspect-ratio: 1/1;
      background: rgba(255,255,255,0.05);
      border: 1px solid var(--border-glass);
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2rem;
      font-weight: 800;
      cursor: pointer;
      transition: 0.2s;
    }
    .ttt-cell:hover:not(.x):not(.o) { background: rgba(255,255,255,0.1); transform: scale(1.05); }
    .ttt-cell.x { color: var(--accent-green); text-shadow: 0 0 10px rgba(52, 211, 153, 0.5); }
    .ttt-cell.o { color: var(--accent-red); text-shadow: 0 0 10px rgba(248, 113, 113, 0.5); }
    .ttt-cell.x, .ttt-cell.o { cursor: default; }

    .game-section {
      width: 100%;
      margin-top: 20px;
      border-top: 1px solid var(--border-glass);
      padding-top: 40px;
    }

    .goal-container {
      margin-bottom: 20px;
      text-align: left;
    }
    .goal-labels { display: flex; justify-content: space-between; font-size: 0.8rem; color: var(--text-muted); margin-bottom: 5px; }
    .progress-bar-bg {
      width: 100%;
      height: 10px;
      background: rgba(255,255,255,0.1);
      border-radius: 10px;
      overflow: hidden;
    }
    .progress-bar-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--accent-green), var(--accent-gold));
      width: 0%;
      transition: width 0.5s ease;
      box-shadow: 0 0 10px var(--accent-green);
    }

    .progress-hint {
      margin-top: 8px;
      font-size: 0.85rem;
      color: var(--text-muted);
      display: flex;
      justify-content: space-between;
      gap: 10px;
      flex-wrap: wrap;
    }
    .progress-hint b { color: var(--accent-green); }

    .balance-display {
      font-family: 'Outfit', sans-serif;
      font-size: 3.5rem;
      font-weight: 800;
      color: var(--text-main);
      text-shadow: 0 0 30px rgba(52, 211, 153, 0.2);
      line-height: 1;
    }

    .balance-subtitle { font-size: 1rem; color: var(--text-muted); margin-top: 5px; }

    .click-area {
      position: relative;
      margin: 40px auto;
      width: 200px;
      height: 200px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .couch-btn {
      width: 160px;
      height: 160px;
      background: linear-gradient(135deg, #10b981, #059669);
      border-radius: 50%;
      border: 8px solid rgba(255, 255, 255, 0.1);
      box-shadow: 0 0 40px rgba(16, 185, 129, 0.3), inset 0 5px 20px rgba(255,255,255,0.2);
      cursor: pointer;
      font-size: 4rem;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: transform 0.1s;
      position: relative;
      z-index: 10;
    }
    .couch-btn:active { transform: scale(0.90); }
    .couch-btn:hover { transform: scale(1.05); box-shadow: 0 0 60px rgba(16, 185, 129, 0.5); }

    .floating-text {
      position: absolute;
      color: var(--accent-gold);
      font-weight: bold;
      font-size: 1.5rem;
      pointer-events: none;
      animation: floatUp 0.8s ease-out forwards;
      z-index: 20;
    }
    @keyframes floatUp {
      0% { transform: translateY(0) scale(1); opacity: 1; }
      100% { transform: translateY(-80px) scale(1.2); opacity: 0; }
    }

    .store-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 15px;
      width: 100%;
    }

    .upgrade-card {
      background: var(--bg-glass);
      border: 1px solid var(--border-glass);
      padding: 15px;
      border-radius: 15px;
      text-align: left;
      transition: all 0.2s ease;
      cursor: pointer;
      position: relative;
      overflow: hidden;
    }
    .upgrade-card.disabled { opacity: 0.5; cursor: default; filter: grayscale(1); pointer-events: none; }
    .upgrade-card:not(.disabled):hover { background: var(--bg-glass-hover); transform: translateY(-3px); border-color: var(--accent-green); }

    .upgrade-name { font-weight: 700; display: block; margin-bottom: 5px; color: var(--text-main); }
    .upgrade-cost { color: var(--accent-gold); font-size: 0.9rem; font-weight: 600; }
    .upgrade-rate { color: var(--text-muted); font-size: 0.8rem; float: right; }
    .upgrade-count { position: absolute; top: 15px; right: 15px; background: rgba(0,0,0,0.3); padding: 2px 8px; border-radius: 10px; font-size: 0.7rem; color: white; }

    .modal-overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.85); backdrop-filter: blur(8px);
      z-index: 100; display: none; align-items: center; justify-content: center;
      padding: 20px;
    }
    .modal-box {
      background: var(--bg-deep); border: 2px solid var(--accent-gold);
      padding: 40px; border-radius: 20px; max-width: 450px; width: 100%; text-align: center;
      box-shadow: 0 0 60px rgba(251, 191, 36, 0.2);
      animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      position: relative;
    }
    @keyframes popIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }

    .modal-title { font-size: 2rem; color: var(--accent-gold); font-family: 'Outfit', sans-serif; margin-bottom: 10px; }
    .modal-btn {
      margin-top: 20px; background: var(--accent-gold); color: var(--bg-deep);
      border: none; padding: 12px 36px; border-radius: 50px; font-weight: 900;
      cursor: pointer; transition: 0.3s; font-family: 'Space Grotesk', sans-serif;
    }
    .modal-btn:hover { transform: scale(1.05); box-shadow: 0 0 15px var(--accent-gold); }
    .modal-btn:active { transform: scale(0.98); }

    .hustle-label { color: var(--accent-green); font-size: 0.8rem; text-transform: uppercase; letter-spacing: 2px; margin-bottom: 5px; display: block;}
    .hustle-text { font-size: 1.1rem; color: #fff; margin-bottom: 15px; font-weight: 700; line-height: 1.4; }
    .hustle-row { text-align: left; background: rgba(255,255,255,0.05); padding: 15px; border-radius: 12px; margin-bottom: 10px; border: 1px solid rgba(255,255,255,0.1); }

    .dossier-box {
      background: #0f172a;
      border: 1px solid var(--accent-green);
      max-width: 600px;
      width: 100%;
      padding: 0;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      max-height: 85vh;
    }
    .dossier-header {
      background: var(--accent-green);
      color: #0f172a;
      padding: 15px;
      font-family: 'Share Tech Mono', monospace;
      text-transform: uppercase;
      letter-spacing: 1px;
      font-weight: bold;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .dossier-content {
      padding: 30px;
      overflow-y: auto;
      text-align: left;
    }
    .dossier-content::-webkit-scrollbar { width: 8px; }
    .dossier-content::-webkit-scrollbar-track { background: rgba(255,255,255,0.05); }
    .dossier-content::-webkit-scrollbar-thumb { background: var(--accent-green); border-radius: 4px; }

    .dossier-title {
      font-family: 'Outfit', sans-serif;
      color: var(--accent-gold);
      font-size: 1.8rem;
      margin-bottom: 20px;
      border-bottom: 1px solid rgba(255,255,255,0.1);
      padding-bottom: 10px;
    }
    .checklist-item {
      display: flex;
      gap: 15px;
      margin-bottom: 15px;
      font-size: 1rem;
      line-height: 1.5;
      color: #e2e8f0;
    }
    .checklist-number {
      color: var(--accent-green);
      font-family: 'Share Tech Mono', monospace;
      font-weight: bold;
      flex-shrink: 0;
    }
    .copy-btn {
      background: rgba(255,255,255,0.1);
      border: 1px solid rgba(255,255,255,0.2);
      color: white;
      padding: 10px;
      width: 100%;
      margin-top: 20px;
      border-radius: 8px;
      cursor: pointer;
      font-family: 'Share Tech Mono', monospace;
      transition: 0.2s;
      font-weight: bold;
    }
    .copy-btn:hover { background: rgba(255,255,255,0.2); }
    .copy-btn.copied { background: var(--accent-green); color: #0f172a; }

    .footer-note { margin-top: 5rem; font-size: 0.9rem; color: rgba(255,255,255,0.4); line-height: 1.8; }
    .fb-link { color: #eaf2ff; text-decoration: none; font-weight: 900; border-bottom: 1px dotted rgba(234,242,255,0.7); transition: 0.2s; }
    .fb-link:hover { color: #ffffff; border-bottom-color: rgba(255,255,255,0.9); }
    .reset-btn { background: none; border: 1px solid #f87171; color: #f87171; padding: 5px 15px; border-radius: 20px; margin-top: 20px; cursor: pointer; font-size: 0.8rem; transition: 0.2s; }
    .reset-btn:hover { background: rgba(248, 113, 113, 0.1); transform: scale(1.05); }

    .fade-in { animation: fadeIn 0.5s ease-in; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes cfConfetti {
      0% { transform: translate(0, 0) rotate(0deg); opacity: 1; }
      100% { transform: translate(var(--vx), calc(var(--vy) + 340px)) rotate(540deg); opacity: 0; }
    }
    @keyframes cfSlideIn {
      from { transform: translateX(18px); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    @keyframes cfSlideOut {
      from { transform: translateX(0); opacity: 1; }
      to { transform: translateX(18px); opacity: 0; }
    }

    .mute-btn {
      position: fixed;
      left: 16px;
      bottom: 16px;
      z-index: 70;
      width: 48px;
      height: 48px;
      border-radius: 50%;
      border: 1px solid var(--border-glass);
      background: var(--bg-glass);
      color: var(--text-main);
      cursor: pointer;
      font-size: 1.2rem;
      display: grid;
      place-items: center;
      backdrop-filter: blur(8px);
    }

    @media (max-width: 900px) {
      .floating-fb { display: none; }
    }

    @media (max-width: 600px) {
      .brand { font-size: 1.2rem; }
      .tip-card { padding: 2rem 1.5rem; }
      .balance-display { font-size: 2.5rem; }
      .couch-btn { width: 140px; height: 140px; font-size: 3rem; }
      .modal-box { padding: 30px 20px; }
      .dossier-title { font-size: 1.4rem; }
      .checklist-item { font-size: 0.9rem; }
      .store-grid { grid-template-columns: 1fr; }
      .achievement-badge { font-size: 0.75rem; padding: 6px 12px; }
      .fb-hero { justify-content: center; }
      .fb-hero-left { justify-content: center; text-align: center; }
      .fb-prominent { justify-content: center; }
      .fb-prominent .left { text-align: center; }
      .referral-badge { justify-content: center; }
      .referral-badge .left { justify-content: center; }
    }
  </style>
</head>
<body>
  <div id="loading-screen">
    <div class="icon">üõãÔ∏è</div>
    <div class="title">Couch Funds</div>
    <div class="sub">Loading your empire...</div>
  </div>

  <div class="orb orb-1"></div>
  <div class="orb orb-2"></div>

  <div class="floating-fb">
    <a class="floating-fb-pill" href="https://web.facebook.com/profile.php?id=61587482075467" target="_blank" rel="noopener">
      <span class="floating-fb-icon">f</span>
      <span class="floating-fb-text">
        <span>Follow Couch Funds</span>
        <small>Facebook Page</small>
      </span>
    </a>
    <button class="floating-fb-pill" onclick="window.shareSiteToFacebook();">
      <span class="floating-fb-icon">‚Üó</span>
      <span class="floating-fb-text">
        <span>Share This Game</span>
        <small>Post/Story</small>
      </span>
    </button>
  </div>

  <div id="offline-modal" class="modal-overlay">
    <div class="modal-box">
      <div class="modal-title">Welcome Back!</div>
      <p>Your assets were working while you were gone.</p>
      <h2 id="offline-amount" style="margin: 20px 0; font-size: 2.5rem; color: var(--accent-green);">+$0.00</h2>
      <button class="modal-btn" onclick="closeModal('offline-modal')">Collect</button>
    </div>
  </div>

  <div id="win-modal" class="modal-overlay">
    <div class="modal-box">
      <div class="modal-title">üèÜ YOU MADE IT!</div>
      <p>You reached $1,000,000 without leaving the couch.</p>
      <div style="font-size: 4rem; margin: 20px;">üõãÔ∏èüëë</div>
      <p style="margin-bottom: 15px;">You are a Couch Tycoon.</p>

      <div class="social-share-bar">
        <a href="#" class="share-btn facebook" onclick="shareWinToFacebook(); return false;">
          üìò Share on Facebook
        </a>
        <a href="#" class="share-btn twitter" onclick="shareToTwitter('millionaire'); return false;">
          üê¶ Twitter
        </a>
        <a href="#" class="share-btn whatsapp" onclick="shareToWhatsApp('millionaire'); return false;">
          üí¨ WhatsApp
        </a>
        <a href="#" class="share-btn copy" onclick="copyShareText('millionaire'); return false;">
          üìã Copy Caption
        </a>
      </div>

      <div class="fb-prominent">
        <div class="left">
          <div class="title">Couch Funds Facebook Page</div>
          <div class="sub">Drop your screenshot + tag the page. The community sees you.</div>
        </div>
        <a class="fb-primary-btn" href="https://web.facebook.com/profile.php?id=61587482075467" target="_blank" rel="noopener">üìò Follow / Visit Page</a>
      </div>

      <button class="modal-btn" onclick="closeModal('win-modal')">Keep Earning</button>
      <button class="modal-btn" style="background: transparent; border: 1px solid var(--accent-gold); color: var(--accent-gold); margin-top: 10px;" onclick="prestigeReset()">Sell & Restart</button>
    </div>
  </div>

  <div id="hustle-modal" class="modal-overlay">
    <div class="modal-box" style="border-color: var(--accent-green);">
      <div style="font-size: 3rem; margin-bottom: 10px;">üîì</div>
      <div class="modal-title" style="color: var(--accent-green);">Secret Hustle Unlocked</div>
      <p style="color: var(--text-muted); margin-bottom: 20px;">Reward for beating the Market AI.</p>

      <div class="hustle-row">
        <span class="hustle-label">The Idea</span>
        <div id="hustle-idea" class="hustle-text">...</div>
      </div>

      <div class="hustle-row">
        <span class="hustle-label">Tools & Platform</span>
        <div id="hustle-tools" style="color: var(--accent-gold); font-weight: 800;">...</div>
      </div>

      <div class="social-share-bar">
        <a href="#" class="share-btn facebook" onclick="shareHustleToFacebook(); return false;">
          üìò Share on Facebook
        </a>
        <a href="#" class="share-btn twitter" onclick="shareToTwitter('hustle'); return false;">
          üê¶ Twitter
        </a>
        <a href="#" class="share-btn whatsapp" onclick="shareToWhatsApp('hustle'); return false;">
          üí¨ WhatsApp
        </a>
        <a href="#" class="share-btn copy" onclick="copyShareText('hustle'); return false;">
          üìã Copy Caption
        </a>
      </div>

      <div class="fb-prominent" style="margin-top: 12px;">
        <div class="left">
          <div class="title">Want the community to see it?</div>
          <div class="sub">Post your win + link the page: <a class="fb-link" href="https://web.facebook.com/profile.php?id=61587482075467" target="_blank" rel="noopener">CouchFunds on Facebook</a></div>
        </div>
        <a class="fb-primary-btn" href="https://web.facebook.com/profile.php?id=61587482075467" target="_blank" rel="noopener">üìò Open Page</a>
      </div>

      <button class="modal-btn" onclick="openDeepDive()">üìÇ Claim Knowledge</button>
    </div>
  </div>

  <div id="deep-dive-modal" class="modal-overlay">
    <div class="modal-box dossier-box">
      <div class="dossier-header">
        <span>CONFIDENTIAL DOSSIER</span>
        <span>#<span id="dossier-id">001</span></span>
      </div>
      <div class="dossier-content">
        <h2 id="dossier-title" class="dossier-title">Loading...</h2>
        <div id="dossier-steps"></div>

        <button class="copy-btn" onclick="copyDossier(event)">üìã COPY STRATEGY TO CLIPBOARD</button>
        <button class="copy-btn" style="background:transparent; border:none; margin-top: 10px; color: #94a3b8;" onclick="closeModal('deep-dive-modal')">Close File</button>
      </div>
    </div>
  </div>

  <div class="container">
    <div class="brand">Couch Funds</div>

    <div class="fb-hero">
      <div class="fb-hero-left">
        <div class="fb-badge">f</div>
        <div>
          <div class="fb-hero-title">Follow the Couch Funds Facebook Page</div>
          <div class="fb-hero-sub">Daily tips + community wins + reposts.</div>
        </div>
      </div>
      <div class="fb-hero-actions">
        <a class="fb-primary-btn" href="https://web.facebook.com/profile.php?id=61587482075467" target="_blank" rel="noopener">üìò Open Page</a>
        <button class="fb-primary-btn" onclick="window.shareSiteToFacebook();">‚Üó Share Site</button>
        <button class="fb-primary-btn" onclick="copyPageLink();">üìã Copy Page Link</button>
      </div>
    </div>

    <!-- REFERRAL BADGE (NEW) -->
    <div class="referral-badge">
      <div class="left">
        <div class="icon">üéÅ</div>
        <div class="text">
          <div class="title">Invite Friends & Climb Faster</div>
          <div class="count" id="referral-count">0 friends referred</div>
        </div>
      </div>
      <button class="referral-btn" onclick="copyReferralLink()">Get Link</button>
    </div>

    <div class="achievements-bar" id="achievements-bar"></div>

    <div class="streak-display" id="streak-display">
      <div class="streak-flame">üî•</div>
      <div>
        <div class="streak-text" id="streak-text">0 Day Streak</div>
        <div class="streak-subtitle" id="streak-subtitle">Come back tomorrow!</div>
      </div>
    </div>

    <div class="leaderboard-section">
      <!-- LEADERBOARD TABS (NEW) -->
      <div class="leaderboard-tabs">
        <button class="leaderboard-tab active" id="tab-alltime" onclick="switchLeaderboard('alltime')">
          üèÜ All-Time
        </button>
        <button class="leaderboard-tab" id="tab-daily" onclick="switchLeaderboard('daily')">
          ‚ö° Today
        </button>
      </div>

      <div class="leaderboard-load-wrap">
        <button class="leaderboard-load-btn" id="load-leaderboard-btn" onclick="enableLeaderboardPolling()">
          üëÄ View Leaderboard
        </button>
      </div>

      <div class="leaderboard-title" id="leaderboard-title">
        üèÜ Top Couch Tycoons (Live)
      </div>
      <div class="leaderboard-list" id="leaderboard-list"></div>

      <p style="margin-top: 15px; font-size: 0.85rem; color: var(--text-muted);" id="player-rank">
        Click "View Leaderboard" to load rankings.
      </p>

      <div class="social-share-bar" style="margin-top: 12px;">
        <a href="#" class="share-btn facebook" onclick="shareLeaderboardToFacebook(); return false;">
          üìò Share My Rank
        </a>
        <a href="#" class="share-btn twitter" onclick="shareToTwitter('rank'); return false;">
          üê¶ Twitter
        </a>
        <a href="#" class="share-btn whatsapp" onclick="shareLeaderboardToWhatsApp(); return false;">
          üí¨ WhatsApp Rank
        </a>
        <a href="#" class="share-btn copy" onclick="copyShareText('rank'); return false;">
          üìã Copy Rank Caption
        </a>
      </div>

      <div class="fb-prominent">
        <div class="left">
          <div class="title">Make your post scream ‚ÄúCouch Funds‚Äù</div>
          <div class="sub">Share your rank + paste the caption. Tag the page so people find it fast.</div>
        </div>
        <a class="fb-primary-btn" href="https://web.facebook.com/profile.php?id=61587482075467" target="_blank" rel="noopener">üìò Tag / Visit Page</a>
      </div>
    </div>

    <div class="tip-card">
      <span id="tip-label" class="tip-label">Tip of the Day</span>
      <div id="tip-text" class="tip-content">Loading wisdom...</div>
      <button class="btn-shuffle" onclick="showRandomTip()">‚Üª Shuffle Wisdom</button>

      <div class="social-share-bar">
        <a href="#" class="share-btn facebook" onclick="shareTipToFacebook(); return false;">
          üìò Share This Tip
        </a>
        <a href="#" class="share-btn twitter" onclick="shareToTwitter('tip'); return false;">
          üê¶ Twitter
        </a>
        <a href="#" class="share-btn whatsapp" onclick="shareTipToWhatsApp(); return false;">
          üí¨ WhatsApp Tip
        </a>
        <a href="#" class="share-btn copy" onclick="copyShareText('tip'); return false;">
          üìã Copy Tip Caption
        </a>
      </div>

      <div class="fb-prominent">
        <div class="left">
          <div class="title">Couch Funds on Facebook</div>
          <div class="sub">Want people to recognize the brand? Share the link + follow the page.</div>
        </div>
        <a class="fb-primary-btn" href="https://web.facebook.com/profile.php?id=61587482075467" target="_blank" rel="noopener">üìò Follow Page</a>
      </div>
    </div>

    <div class="tip-card">
      <span class="tip-label">Investor Strategy Challenge</span>
      <p style="margin-bottom: 20px; font-size: 0.9rem; color: var(--text-muted);">Beat the Market (AI) to unlock a <b style="color: var(--accent-green)">Secret Hustle</b>.</p>
      <div id="ttt-board"></div>
      <p id="ttt-status" style="margin-top: 15px; color: var(--accent-gold); font-weight: 900;">Your Move, Investor.</p>
      <button class="btn-shuffle" onclick="resetTTT()">Restart Challenge</button>
    </div>

    <div class="game-section">
      <div class="goal-container">
        <div class="goal-labels">
          <span>Progress</span>
          <span>Goal: $1,000,000</span>
        </div>
        <div class="progress-bar-bg">
          <div id="progress-fill" class="progress-bar-fill"></div>
        </div>

        <div class="progress-hint">
          <span id="progress-text">$0 / $1,000,000</span>
          <span id="progress-percent"><b>0.0%</b></span>
        </div>
      </div>

      <div class="game-header">
        <div class="balance-subtitle">Net Worth</div>
        <div id="balance" class="balance-display">$0.00</div>
        <div id="income-display" class="balance-subtitle" style="color: var(--accent-green); margin-top: 5px;">+$0.00 / sec</div>
      </div>

      <div class="click-area">
        <div class="couch-btn" id="click-btn">üõãÔ∏è</div>
      </div>

      <div class="store-grid" id="store-grid"></div>
    </div>

    <div class="footer-note">
      Tips update daily. Track your streak!<br>
      Follow the page: <a href="https://web.facebook.com/profile.php?id=61587482075467" target="_blank" rel="noopener" class="fb-link">CouchFunds on Facebook</a><br>
      <button class="reset-btn" onclick="hardReset()">‚ö†Ô∏è Wipe Save & Reset</button>
    </div>
  </div>

  <script type="module">
    window.__firebaseInitPromise = (async () => {
      try {
        const { initializeApp } = await import("https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js");
        const {
          getFirestore, getDocs, deleteDoc, doc, setDoc, collection, query, orderBy, limit,
          serverTimestamp, runTransaction, where, Timestamp
        } = await import("https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js");

        const firebaseConfig = {
          apiKey: "AIzaSyCs6VvYUFCQl7TlLgrY62jyfBUFhj5wMwo",
          authDomain: "couchfunds-fc312.firebaseapp.com",
          projectId: "couchfunds-fc312",
          storageBucket: "couchfunds-fc312.firebasestorage.app",
          messagingSenderId: "696869566029",
          appId: "1:696869566029:web:ae6b0f4b2b6e481fa1ce04"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        window.__FIREBASE__ = {
          db, getDocs, deleteDoc, doc, setDoc, collection, query, orderBy, limit,
          serverTimestamp, runTransaction, where, Timestamp
        };

        return true;
      } catch (e) {
        console.error("Firebase init failed:", e);
        return false;
      }
    })();
  </script>

  <script>
    // =========================
    // IDs / NAMES
    // =========================
    const DEVICE_LOCK_KEY = "cf_device_lock";
    const DAILY_REWARD_KEY = "cf_last_reward";
    const DAILY_LEADERBOARD_RESET_KEY = "cf_last_lb_reset";
    const DAILY_TOP10_BONUS = 10;

    function getLocalDateKey(date = new Date()) {
      const y = date.getFullYear();
      const m = String(date.getMonth() + 1).padStart(2, "0");
      const d = String(date.getDate()).padStart(2, "0");
      return `${y}-${m}-${d}`;
    }

    function normalizeStoredDateKey(rawValue) {
      const raw = String(rawValue || "").trim();
      if (!raw) return "";
      if (/^\d{4}-\d{2}-\d{2}$/.test(raw)) return raw;

      const parsed = new Date(raw);
      if (Number.isNaN(parsed.getTime())) return "";
      return getLocalDateKey(parsed);
    }

    function getDeviceFingerprint() {
      try {
        const canvas = document.createElement("canvas");
        const ctx = canvas.getContext("2d");
        let canvasSig = "";

        if (ctx) {
          ctx.textBaseline = "top";
          ctx.font = "14px Arial";
          ctx.fillStyle = "#f60";
          ctx.fillRect(125, 1, 62, 20);
          ctx.fillStyle = "#069";
          ctx.fillText("couchfunds-fingerprint", 2, 15);
          canvasSig = canvas.toDataURL().slice(0, 120);
        }

        const seed = [
          navigator.userAgent || "",
          navigator.language || "",
          String(screen.colorDepth || ""),
          `${screen.width || 0}x${screen.height || 0}`,
          String(new Date().getTimezoneOffset()),
          canvasSig
        ].join("|");

        let hash = 0;
        for (let i = 0; i < seed.length; i++) {
          const ch = seed.charCodeAt(i);
          hash = ((hash << 5) - hash) + ch;
          hash |= 0;
        }
        return `fp_${Math.abs(hash).toString(36)}`;
      } catch {
        return "fp_unknown";
      }
    }

    function getLockedUsername() {
      const raw = localStorage.getItem(DEVICE_LOCK_KEY);
      if (!raw) return "";

      try {
        const data = JSON.parse(raw);
        if (!data || data.fingerprint !== getDeviceFingerprint()) return "";
        const locked = sanitizeName(data.username || "", { allowFallback: false });
        return isValidPublicUsername(locked) ? locked : "";
      } catch {
        return "";
      }
    }

    function lockUsernameToDevice(username) {
      const clean = sanitizeName(username, { allowFallback: false });
      if (!isValidPublicUsername(clean)) return;
      localStorage.setItem(DEVICE_LOCK_KEY, JSON.stringify({
        fingerprint: getDeviceFingerprint(),
        username: clean,
        playerId: localStorage.getItem("cf_player_id") || "",
        lockedAt: Date.now()
      }));
    }

    function getPlayerId() {
      const stableId = `cf_${getDeviceFingerprint()}`;
      if (localStorage.getItem("cf_player_id") !== stableId) {
        localStorage.setItem("cf_player_id", stableId);
      }
      return stableId;
    }

    function normalizeUsername(name) {
      return (name || "")
        .normalize("NFKC")
        .replace(/\s+/g, " ")
        .trim()
        .toLowerCase();
    }

    function sanitizeName(name, { allowFallback = true } = {}) {
      let s = (name || "")
        .normalize("NFKC")
        .replace(/[<>`"'\\]/g, "")
        .replace(/[^\p{L}\p{N}\s._-]/gu, "")
        .replace(/\s+/g, " ")
        .trim()
        .slice(0, 16);

      return s || (allowFallback ? "Anonymous" : "");
    }

    function isInappropriate(name) {
      const n = normalizeUsername(name);

      if (!n) return true;
      if (n === "anonymous") return true;

      // only block truly bad patterns (don't block short names anymore)
      const banned = ["nazi","hitler","kkk","rape","rapist","pedo","pedophile","porn","sex","cunt","nigger","faggot","bitch","whore"];

      if (/^\d+$/.test(n)) return true;              // only numbers
      if (/(.)\1\1\1/.test(n)) return true;          // aaaa
      if (banned.some(w => n.includes(w))) return true;

      return false;
    }

    function isValidPublicUsername(name) {
      const clean = sanitizeName(name, { allowFallback: false });
      return !!clean && clean.length >= 3 && normalizeUsername(clean) !== "anonymous" && !isInappropriate(clean);
    }

    function getFirestoreErrorCode(err) {
      const direct = String(err?.code || "").toLowerCase();
      if (direct) return direct.includes("/") ? direct.split("/").pop() : direct;

      const msg = String(err?.message || "").toLowerCase();
      if (msg.includes("resource-exhausted") || msg.includes("quota exceeded")) return "resource-exhausted";
      if (msg.includes("permission-denied") || msg.includes("missing or insufficient permissions")) return "permission-denied";
      if (msg.includes("failed-precondition")) return "failed-precondition";
      if (msg.includes("deadline-exceeded")) return "deadline-exceeded";
      if (msg.includes("unavailable")) return "unavailable";
      if (msg.includes("network")) return "network";
      return "";
    }

    async function pickUsernameFlow(currentName = "") {
      while (true) {
        const raw = prompt("Choose a leaderboard name (3-16 chars):", currentName);
        if (raw === null || !(raw || "").trim()) {
          alert("You must enter a username to continue.");
          continue;
        }

        const clean = sanitizeName(raw, { allowFallback: false });
        if (!isValidPublicUsername(clean)) {
          alert("That name isn't allowed. Please choose a real username.");
          continue;
        }

        return clean;
      }
    }

    // =========================
    // DUPLICATE NAME PREVENTION (Firestore usernames collection)
    // =========================
    async function claimUsernameOrThrow(chosenName) {
      const clean = sanitizeName(chosenName, { allowFallback: false });
      const key = normalizeUsername(clean).replace(/\s/g, "_");

      if (!isValidPublicUsername(clean)) {
        throw new Error("bad_name");
      }
      if (!window.__FIREBASE__) throw new Error("no_firebase");
      if (typeof isFirestoreDisabled === "function" && isFirestoreDisabled()) throw new Error("firestore_disabled");

      const { db, doc, runTransaction, serverTimestamp } = window.__FIREBASE__;
      const nameDocRef = doc(db, "usernames", key);

      await runTransaction(db, async (tx) => {
        const snap = await tx.get(nameDocRef);

        if (snap.exists()) {
          const data = snap.data();
          if (data.playerId !== PLAYER_ID) {
            throw new Error("name_taken");
          }
          // already yours
        } else {
          tx.set(nameDocRef, { playerId: PLAYER_ID, name: clean, claimedAt: serverTimestamp() });
        }
      });

      return clean;
    }

    async function releaseUsernameIfOwned(oldName) {
      if (!oldName || !window.__FIREBASE__) return;
      const key = normalizeUsername(oldName).replace(/\s/g, "_");
      const { db, doc, runTransaction } = window.__FIREBASE__;
      const ref = doc(db, "usernames", key);

      await runTransaction(db, async (tx) => {
        const snap = await tx.get(ref);
        if (snap.exists() && snap.data().playerId === PLAYER_ID) {
          tx.delete(ref);
        }
      });
    }

    async function syncDeviceLockOnServer(candidateName) {
      const clean = sanitizeName(candidateName, { allowFallback: false });
      if (!clean || !window.__FIREBASE__) return clean;
      if (typeof isFirestoreDisabled === "function" && isFirestoreDisabled()) return clean;

      const { db, doc, runTransaction, serverTimestamp } = window.__FIREBASE__;
      const fingerprint = getDeviceFingerprint();
      const lockRef = doc(db, "device_locks", fingerprint);
      let lockedName = clean;

      await runTransaction(db, async (tx) => {
        const snap = await tx.get(lockRef);

        if (snap.exists()) {
          const data = snap.data() || {};
          const existing = sanitizeName(data.username || "", { allowFallback: false });
          if (isValidPublicUsername(existing)) {
            lockedName = existing;
          }
          tx.set(lockRef, {
            playerId: PLAYER_ID,
            username: lockedName,
            lastSeenAt: serverTimestamp()
          }, { merge: true });
          return;
        }

        tx.set(lockRef, {
          fingerprint,
          playerId: PLAYER_ID,
          username: clean,
          lockedAt: serverTimestamp(),
          lastSeenAt: serverTimestamp()
        });
        lockedName = clean;
      });

      return lockedName;
    }

    async function initUsername() {
      const lockedLocal = getLockedUsername();
      const rawSaved = localStorage.getItem("cf_username");
      const saved = (rawSaved && rawSaved !== "null" && rawSaved !== "undefined")
        ? rawSaved
        : "";

      let stored = lockedLocal || (saved ? sanitizeName(saved, { allowFallback: false }) : "");

      if (!isValidPublicUsername(stored)) {
        stored = await pickUsernameFlow("");
      }

      if (window.__FIREBASE__ && !(typeof isFirestoreDisabled === "function" && isFirestoreDisabled())) {
        try {
          const serverLocked = await syncDeviceLockOnServer(stored);
          if (serverLocked && normalizeUsername(serverLocked) !== normalizeUsername(stored)) {
            stored = serverLocked;
          }
        } catch (err) {
          if (typeof handleFirestoreError === "function") handleFirestoreError(err, "device_lock");
          console.warn("Device lock sync skipped:", err);
        }
      }

      if (!isValidPublicUsername(stored)) {
        stored = await pickUsernameFlow("");
      }

      USERNAME = stored;
      localStorage.setItem("cf_username", USERNAME);
      lockUsernameToDevice(USERNAME);
      return USERNAME;
    }

    const PLAYER_ID = getPlayerId();
    const storedUsername = localStorage.getItem("cf_username");
    let USERNAME = (storedUsername && storedUsername !== "null" && storedUsername !== "undefined")
      ? sanitizeName(storedUsername, { allowFallback: false })
      : "";
    if (!isValidPublicUsername(USERNAME)) USERNAME = "";

    // Rename with uniqueness
    window.renameCouchFundsUser = async () => {
      const localLock = getLockedUsername();
      const nextName = await pickUsernameFlow(USERNAME || "");
      if (!nextName) return;

      if (localLock && normalizeUsername(nextName) !== normalizeUsername(localLock)) {
        alert(`This device is locked to "${localLock}".`);
        return;
      }

      // If firebase not ready yet, just set locally and claim later.
      if (!window.__FIREBASE__) {
        USERNAME = sanitizeName(nextName, { allowFallback: false });
        localStorage.setItem("cf_username", USERNAME);
        lockUsernameToDevice(USERNAME);
        markLeaderboardDirty();
        alert("Saved locally. We'll validate uniqueness when leaderboard connects.");
        return;
      }

      if (typeof isFirestoreDisabled === "function" && isFirestoreDisabled()) {
        USERNAME = sanitizeName(nextName, { allowFallback: false });
        localStorage.setItem("cf_username", USERNAME);
        lockUsernameToDevice(USERNAME);
        markLeaderboardDirty();
        alert("Saved locally, but leaderboard is paused (quota exceeded).");
        return;
      }

      try {
        const claimed = await claimUsernameOrThrow(nextName);
        const serverLocked = await syncDeviceLockOnServer(claimed).catch(() => claimed);
        USERNAME = serverLocked || claimed;
        localStorage.setItem("cf_username", USERNAME);
        lockUsernameToDevice(USERNAME);
        markLeaderboardDirty();
      } catch (e) {
        const code = getFirestoreErrorCode(e);
        if (e?.message === "name_taken") {
          alert("Name already taken.");
          return;
        }
        if (e?.message === "bad_name") {
          alert("That name isn't allowed.");
          return;
        }
        if (code === "resource-exhausted") {
          if (typeof handleFirestoreError === "function") handleFirestoreError(e, "username_claim");
          USERNAME = sanitizeName(nextName, { allowFallback: false });
          localStorage.setItem("cf_username", USERNAME);
          lockUsernameToDevice(USERNAME);
          markLeaderboardDirty();
          alert("Saved locally, but could not verify uniqueness (quota exceeded).");
          return;
        }
        if (code === "permission-denied" || code === "deadline-exceeded" || code === "unavailable" || code === "network") {
          USERNAME = sanitizeName(nextName, { allowFallback: false });
          localStorage.setItem("cf_username", USERNAME);
          lockUsernameToDevice(USERNAME);
          markLeaderboardDirty();
          alert("Saved locally, but could not verify uniqueness right now.");
          return;
        }
        alert("Couldn't save that name right now. Try again.");
      }
    };

    // =========================
    // ACHIEVEMENTS
    // =========================
    const achievements = [
      { id: 'first_click', name: 'First Click', icon: 'üëÜ', condition: () => gameState.totalClicks >= 1 },
      { id: 'first_1k', name: '$1,000', icon: 'üí∞', condition: () => gameState.balance >= 1000 },
      { id: 'market_beater', name: 'Market Beater', icon: 'üéØ', condition: () => gameState.hasBeatenAI },
      { id: 'first_upgrade', name: 'Investor', icon: 'üìà', condition: () => gameState.totalUpgrades >= 1 },
      { id: 'millionaire', name: 'Millionaire', icon: 'üëë', condition: () => gameState.balance >= 1000000 },
      { id: 'week_streak', name: '7 Day Streak', icon: 'üî•', condition: () => gameState.streak >= 7 }
    ];

    function celebrateAchievement(achievement) {
      const colors = ['#fbbf24', '#34d399', '#a78bfa'];

      for (let i = 0; i < 24; i++) {
        const confetti = document.createElement('div');
        confetti.style.position = 'fixed';
        confetti.style.left = '50%';
        confetti.style.top = '18%';
        confetti.style.width = '8px';
        confetti.style.height = '8px';
        confetti.style.borderRadius = '50%';
        confetti.style.background = colors[Math.floor(Math.random() * colors.length)];
        confetti.style.pointerEvents = 'none';
        confetti.style.zIndex = '1000';

        const angle = Math.random() * Math.PI * 2;
        const velocity = 160 + Math.random() * 180;
        confetti.style.setProperty('--vx', `${Math.cos(angle) * velocity}px`);
        confetti.style.setProperty('--vy', `${Math.sin(angle) * velocity - 220}px`);
        confetti.style.animation = 'cfConfetti 1.8s ease-out forwards';

        document.body.appendChild(confetti);
        setTimeout(() => confetti.remove(), 1900);
      }

      const toast = document.createElement('div');
      toast.style.position = 'fixed';
      toast.style.right = '16px';
      toast.style.top = '16px';
      toast.style.zIndex = '1001';
      toast.style.padding = '14px 18px';
      toast.style.borderRadius = '12px';
      toast.style.background = 'linear-gradient(135deg, #fbbf24, #f59e0b)';
      toast.style.color = '#052e24';
      toast.style.fontWeight = '900';
      toast.style.boxShadow = '0 12px 24px rgba(0,0,0,0.28)';
      toast.style.animation = 'cfSlideIn 0.25s ease-out';
      toast.textContent = `üéâ ${achievement.icon} ${achievement.name} Unlocked`;
      document.body.appendChild(toast);

      setTimeout(() => {
        toast.style.animation = 'cfSlideOut 0.25s ease-in forwards';
        setTimeout(() => toast.remove(), 260);
      }, 2200);
    }

    function checkAchievements() {
      let newUnlocks = false;
      achievements.forEach(ach => {
        if (!gameState.unlockedAchievements.includes(ach.id) && ach.condition()) {
          gameState.unlockedAchievements.push(ach.id);
          newUnlocks = true;
          celebrateAchievement(ach);

          // GA tracking (NEW)
          if (typeof trackEvent === 'function') {
            trackEvent('Achievement', 'unlock', ach.id);
          }
        }
      });
      if (newUnlocks) {
        renderAchievements();
        saveGame();
      }
    }

    function renderAchievements() {
      const container = document.getElementById('achievements-bar');
      container.innerHTML = '';
      achievements.forEach(ach => {
        const badge = document.createElement('div');
        const isUnlocked = gameState.unlockedAchievements.includes(ach.id);
        badge.className = `achievement-badge ${isUnlocked ? 'unlocked' : 'locked'}`;
        badge.innerHTML = `<span>${ach.icon}</span><span>${ach.name}</span>`;
        badge.title = isUnlocked ? `Unlocked: ${ach.name}` : `Locked: ${ach.name}`;
        container.appendChild(badge);
      });
    }

    // =========================
    // STREAK
    // =========================
    function updateStreak() {
      const today = getLocalDateKey();
      const lastVisit = normalizeStoredDateKey(gameState.lastVisitDate);

      if (lastVisit !== today) {
        const yesterday = new Date();
        yesterday.setDate(yesterday.getDate() - 1);
        const yesterdayStr = getLocalDateKey(yesterday);

        if (lastVisit === yesterdayStr) {
          gameState.streak += 1;
        } else if (lastVisit !== today) {
          gameState.streak = 1;
        }

        gameState.lastVisitDate = today;
        saveGame();
      }

      renderStreak();
    }

    function renderStreak() {
      const streakText = document.getElementById('streak-text');
      const streakSubtitle = document.getElementById('streak-subtitle');

      streakText.textContent = `${gameState.streak} Day Streak`;

      if (gameState.streak >= 7) {
        streakSubtitle.textContent = "üåü You're on fire! Keep it up!";
      } else if (gameState.streak >= 3) {
        streakSubtitle.textContent = "Great momentum! Don't break it!";
      } else {
        streakSubtitle.textContent = "Come back tomorrow to build your streak!";
      }

      checkAchievements();
    }

    function checkDailyReward() {
      const today = getLocalDateKey();
      const lastRewardRaw = localStorage.getItem(DAILY_REWARD_KEY);
      const lastReward = normalizeStoredDateKey(lastRewardRaw);
      if (lastReward && lastRewardRaw !== lastReward) {
        localStorage.setItem(DAILY_REWARD_KEY, lastReward);
      }
      if (lastReward === today) return;

      const reward = 1000 * Math.max(1, gameState.streak || 1);
      gameState.balance += reward;
      localStorage.setItem(DAILY_REWARD_KEY, today);

      const modal = document.createElement('div');
      modal.className = 'modal-overlay';
      modal.style.display = 'flex';
      modal.innerHTML = `
        <div class="modal-box" style="border-color: var(--accent-gold);">
          <div class="modal-title">üéÅ Daily Reward</div>
          <p style="font-size: 1.5rem; margin: 10px 0; color: var(--accent-green);">+${moneyFormat.format(reward)}</p>
          <p style="color: var(--text-muted);">Day ${gameState.streak} streak bonus</p>
          <button class="modal-btn" style="margin-top: 18px;" onclick="this.closest('.modal-overlay').remove()">Claim</button>
        </div>
      `;
      document.body.appendChild(modal);
      saveGame(true);
    }

    // =========================
    // LEADERBOARD (All-time + Daily)
    // =========================
    let leaderboardUnsubscribe = null;
    let leaderboardDirty = false;
    let lastLeaderboardSyncMs = 0;
    let lastSyncedBalance = 0;
    let lastDirtyBalance = 0;
    let currentLeaderboardMode = 'alltime';
    let leaderboardActivated = false;
    let leaderboardPublishTimer = null;
    let leaderboardSyncInterval = null;
    let leaderboardPollInterval = null;
    let leaderboardPollInFlight = false;
    let saveLoopInterval = null;
    const LEADERBOARD_DEBOUNCE_MS = 20000;
    const LEADERBOARD_MIN_SYNC_MS = 20000;
    const LEADERBOARD_POLL_INTERVAL_MS = 60000;
    const LEADERBOARD_PUBLISH_MILESTONES = [10000, 100000, 500000, 1000000];
    const MAX_LEADERBOARD_BALANCE = 10000000;
    let lastPublishedMilestone = 0;

    const FIRESTORE_DISABLED_UNTIL_KEY = "cf_fs_disabled_until";
    const FIRESTORE_BACKOFF_MS = 15 * 60 * 1000;
    let firestoreDisabledUntil = Number(localStorage.getItem(FIRESTORE_DISABLED_UNTIL_KEY) || "0") || 0;

    function isFirestoreDisabled() {
      return Date.now() < firestoreDisabledUntil;
    }

    function setLeaderboardStatus(text) {
      const el = document.getElementById("player-rank");
      if (el) el.textContent = text;
    }

    function setLeaderboardLoadButtonState() {
      const btn = document.getElementById("load-leaderboard-btn");
      if (!btn) return;

      if (isFirestoreDisabled()) {
        btn.textContent = "Leaderboard Paused";
        btn.disabled = true;
        return;
      }

      btn.disabled = false;
      btn.textContent = leaderboardActivated ? "üîÑ Refresh Leaderboard" : "üëÄ View Leaderboard";
    }

    function disableFirestoreFor(ms, reason = "") {
      firestoreDisabledUntil = Date.now() + Math.max(0, ms || 0);
      localStorage.setItem(FIRESTORE_DISABLED_UNTIL_KEY, String(firestoreDisabledUntil));
      setLeaderboardStatus("Leaderboard paused (quota exceeded). Try again later.");
      if (reason) console.warn("Firestore disabled:", reason);
      if (leaderboardPublishTimer) {
        clearTimeout(leaderboardPublishTimer);
        leaderboardPublishTimer = null;
      }
      if (leaderboardSyncInterval) {
        clearInterval(leaderboardSyncInterval);
        leaderboardSyncInterval = null;
      }
      try { stopLeaderboardPolling(); } catch {}
      setLeaderboardLoadButtonState();
    }

    function handleFirestoreError(err, context = "") {
      const code = getFirestoreErrorCode(err);
      if (code === "resource-exhausted") {
        disableFirestoreFor(FIRESTORE_BACKOFF_MS, context || "resource-exhausted");
      }
    }

    function markLeaderboardDirty() {
      leaderboardDirty = true;
    }

    function queueLeaderboardPublish(_reason = "") {
      if (isResetting) return;
      markLeaderboardDirty();
      if (isFirestoreDisabled()) return;
      if (!window.__FIREBASE__) return;

      if (leaderboardPublishTimer) {
        clearTimeout(leaderboardPublishTimer);
      }
      leaderboardPublishTimer = setTimeout(() => {
        leaderboardPublishTimer = null;
        syncScoreToFirestore(false).catch(() => {});
      }, LEADERBOARD_DEBOUNCE_MS);
    }

    async function checkDailyLeaderboardReset() {
      if (!window.__FIREBASE__) return;
      if (isResetting) return;
      if (isFirestoreDisabled()) return;

      const today = getLocalDateKey();
      const resetRaw = localStorage.getItem(DAILY_LEADERBOARD_RESET_KEY);
      const lastLocalReset = normalizeStoredDateKey(resetRaw);
      if (lastLocalReset && resetRaw !== lastLocalReset) {
        localStorage.setItem(DAILY_LEADERBOARD_RESET_KEY, lastLocalReset);
      }
      if (lastLocalReset === today) return;

      const y = new Date();
      y.setDate(y.getDate() - 1);
      const yesterday = getLocalDateKey(y);

      const { db, collection, query, where, orderBy, limit, getDocs, doc, runTransaction, serverTimestamp } = window.__FIREBASE__;
      const topPlayers = [];

      try {
        try {
          const q = query(
            collection(db, "leaderboard"),
            where("dailyDate", "==", yesterday),
            orderBy("dailyBalance", "desc"),
            limit(10)
          );
          const snap = await getDocs(q);
          snap.forEach(d => topPlayers.push({ id: d.id }));
        } catch (e) {
          const code = getFirestoreErrorCode(e);
          if (code !== "failed-precondition") throw e;

          const q = query(
            collection(db, "leaderboard"),
            where("dailyDate", "==", yesterday),
            limit(40)
          );
          const snap = await getDocs(q);
          const fallbackPlayers = [];
          snap.forEach(d => fallbackPlayers.push({ id: d.id, ...d.data() }));
          fallbackPlayers
            .sort((a, b) => Number(b.dailyBalance || 0) - Number(a.dailyBalance || 0))
            .slice(0, 10)
            .forEach(p => topPlayers.push({ id: p.id }));
        }

        await Promise.all(topPlayers.map(async (p, index) => {
          const playerRef = doc(db, "leaderboard", p.id);
          await runTransaction(db, async (tx) => {
            const snap = await tx.get(playerRef);
            if (!snap.exists()) return;

            const data = snap.data() || {};
            const alreadyAwarded = normalizeStoredDateKey(data.dailyBonusDate) === today;
            if (alreadyAwarded) return;

            const pendingBonus = Math.max(0, Number(data.pendingBonus || 0));
            tx.set(playerRef, {
              pendingBonus: pendingBonus + DAILY_TOP10_BONUS,
              dailyBonusDate: today,
              dailyBalance: DAILY_TOP10_BONUS,
              dailyDate: today,
              lastDayRank: index + 1,
              updatedAt: serverTimestamp()
            }, { merge: true });
          });
        }));

        localStorage.setItem(DAILY_LEADERBOARD_RESET_KEY, today);
      } catch (err) {
        handleFirestoreError(err, "daily_leaderboard_reset");
        console.error("Daily leaderboard reset error:", err);
      }
    }

    // One-time maintenance helper. Run from console: cleanupDuplicateAnonymous()
    async function cleanupDuplicateAnonymous() {
      if (!window.__FIREBASE__) {
        alert("Firebase not ready.");
        return;
      }

      const { db, collection, query, where, getDocs, deleteDoc, doc } = window.__FIREBASE__;
      try {
        const q = query(collection(db, "leaderboard"), where("name", "==", "Anonymous"));
        const snap = await getDocs(q);
        if (!snap.size) {
          alert("No Anonymous entries found.");
          return;
        }

        const ok = confirm(`Delete ${snap.size} Anonymous leaderboard entries? This cannot be undone.`);
        if (!ok) return;

        const deletes = [];
        snap.forEach((d) => {
          deletes.push(deleteDoc(doc(db, "leaderboard", d.id)));
        });
        await Promise.all(deletes);

        alert(`Deleted ${snap.size} Anonymous entries.`);
        location.reload();
      } catch (err) {
        console.error("Cleanup error:", err);
        alert(`Cleanup failed: ${err?.message || err}`);
      }
    }
    window.cleanupDuplicateAnonymous = cleanupDuplicateAnonymous;

    function switchLeaderboard(mode) {
      if (mode === currentLeaderboardMode) return;
      currentLeaderboardMode = mode;

      document.querySelectorAll('.leaderboard-tab').forEach(tab => tab.classList.remove('active'));
      const t = document.getElementById(`tab-${mode}`);
      if (t) t.classList.add('active');

      const titleEl = document.getElementById('leaderboard-title');
      if (mode === 'daily') titleEl.innerHTML = '‚ö° Top Earners Today';
      else titleEl.innerHTML = 'üèÜ Top Couch Tycoons (Live)';

      if (typeof trackEvent === 'function') {
        trackEvent('Leaderboard', 'switch_tab', mode);
      }

      if (leaderboardActivated) {
        startLiveLeaderboard();
      } else {
        setLeaderboardStatus('Click "View Leaderboard" to load rankings.');
      }
    }
    window.switchLeaderboard = switchLeaderboard;

    function enableLeaderboardPolling() {
      leaderboardActivated = true;
      setLeaderboardLoadButtonState();
      startLiveLeaderboard();
    }
    window.enableLeaderboardPolling = enableLeaderboardPolling;

    async function syncScoreToFirestore(force = false) {
      if (!window.__FIREBASE__) return;
      if (isResetting) return;
      if (isFirestoreDisabled()) return;
      const publicName = sanitizeName(USERNAME, { allowFallback: false });
      if (!isValidPublicUsername(publicName)) return;

      const now = Date.now();
      if (!force && !leaderboardDirty) return;
      if (!force && (now - lastLeaderboardSyncMs < LEADERBOARD_MIN_SYNC_MS)) return;
      const balanceInt = Math.max(0, Math.floor(gameState.balance));

      const { db, doc, runTransaction, serverTimestamp } = window.__FIREBASE__;

      try {
        const today = getLocalDateKey();
        const sessionSeconds = Math.max(1, Math.floor((now - (gameState.firstPlayTime || now)) / 1000));
        const rateCapByPlaytime = Math.floor(sessionSeconds * Math.max(1, gameState.income + gameState.clickValue * 2));
        let claimedBonus = 0;
        let syncedBalance = balanceInt;

        await runTransaction(db, async (tx) => {
          const playerRef = doc(db, "leaderboard", PLAYER_ID);
          const snap = await tx.get(playerRef);
          const prev = snap.exists() ? (snap.data() || {}) : {};

          const prevBalance = Math.max(0, Number(prev.balance || 0));
          const prevDailyBalance = Math.max(0, Number(prev.dailyBalance || 0));
          const prevDailyDate = normalizeStoredDateKey(prev.dailyDate);
          const pendingBonus = Math.max(0, Number(prev.pendingBonus || 0));
          claimedBonus = pendingBonus;

          const effectiveBalance = Math.max(0, balanceInt + pendingBonus);
          const safeBalance = Math.min(effectiveBalance, MAX_LEADERBOARD_BALANCE, rateCapByPlaytime + 25000);
          syncedBalance = safeBalance;

          const gainSinceLastSync = Math.max(0, safeBalance - prevBalance);
          let nextDailyBalance = prevDailyDate === today
            ? (prevDailyBalance + gainSinceLastSync)
            : gainSinceLastSync;

          if (prevDailyDate === today && prevDailyBalance > nextDailyBalance) {
            nextDailyBalance = prevDailyBalance;
          }

          tx.set(
            playerRef,
            {
              playerId: PLAYER_ID,
              name: publicName,
              balance: safeBalance,
              updatedAt: serverTimestamp(),
              dailyBalance: nextDailyBalance,
              dailyDate: today,
              pendingBonus: 0,
              referralCode: getReferralCode(),
              referredBy: getReferredBy() || null,
              playTime: sessionSeconds
            },
            { merge: true }
          );
        });

        if (claimedBonus > 0) {
          gameState.balance += claimedBonus;
          saveGame(true);
          updateUI();
        }

        lastLeaderboardSyncMs = Date.now();
        lastSyncedBalance = syncedBalance;
        lastDirtyBalance = Math.max(0, Math.floor(gameState.balance));
        leaderboardDirty = false;
      } catch (err) {
        handleFirestoreError(err, "sync_score");
        console.error("Firestore sync error:", err);
      }
    }

    function stopLeaderboardPolling() {
      if (leaderboardPollInterval) {
        clearInterval(leaderboardPollInterval);
        leaderboardPollInterval = null;
      }
      // Back-compat: if an older build left a listener around, make sure it's off.
      if (leaderboardUnsubscribe) {
        try { leaderboardUnsubscribe(); } catch {}
        leaderboardUnsubscribe = null;
      }
    }

    async function fetchLeaderboardOnce() {
      if (!window.__FIREBASE__) return;
      if (isResetting) return;
      if (isFirestoreDisabled()) return;
      if (leaderboardPollInFlight) return;
      leaderboardPollInFlight = true;

      const { db, collection, query, orderBy, limit, where, getDocs } = window.__FIREBASE__;
      const today = getLocalDateKey();

      try {
        const players = [];

        if (currentLeaderboardMode === 'daily') {
          // Prefer an indexed query (where + orderBy). If the index doesn't exist, fall back to a smaller sample.
          try {
            const q = query(
              collection(db, "leaderboard"),
              where("dailyDate", "==", today),
              orderBy("dailyBalance", "desc"),
              limit(10)
            );
            const snap = await getDocs(q);
            snap.forEach(d => players.push({ id: d.id, ...d.data() }));
            renderLeaderboard(players);
            return;
          } catch (e) {
            const code = getFirestoreErrorCode(e);
            if (code !== "failed-precondition") throw e;

            const q = query(
              collection(db, "leaderboard"),
              where("dailyDate", "==", today),
              limit(30)
            );
            const snap = await getDocs(q);
            snap.forEach(d => players.push({ id: d.id, ...d.data() }));
            players.sort((a, b) => Number(b.dailyBalance || 0) - Number(a.dailyBalance || 0));
            renderLeaderboard(players.slice(0, 10));
            return;
          }
        }

        const q = query(
          collection(db, "leaderboard"),
          orderBy("balance", "desc"),
          limit(10)
        );
        const snap = await getDocs(q);
        snap.forEach(d => players.push({ id: d.id, ...d.data() }));
        renderLeaderboard(players);
      } catch (err) {
        handleFirestoreError(err, "leaderboard_fetch");
        console.error("Leaderboard fetch error:", err);
        if (!isFirestoreDisabled()) setLeaderboardStatus("Leaderboard offline (check connection/quota).");
      } finally {
        leaderboardPollInFlight = false;
      }
    }

    function startLiveLeaderboard() {
      if (!window.__FIREBASE__) return;
      if (!leaderboardActivated) {
        setLeaderboardStatus('Click "View Leaderboard" to load rankings.');
        setLeaderboardLoadButtonState();
        return;
      }
      if (isFirestoreDisabled()) {
        setLeaderboardStatus("Leaderboard paused (quota exceeded). Try again later.");
        setLeaderboardLoadButtonState();
        return;
      }

      stopLeaderboardPolling();
      setLeaderboardStatus("Loading leaderboard...");
      setLeaderboardLoadButtonState();
      fetchLeaderboardOnce();
      leaderboardPollInterval = setInterval(fetchLeaderboardOnce, LEADERBOARD_POLL_INTERVAL_MS);
    }

    function renderLeaderboard(players) {
      const list = document.getElementById("leaderboard-list");
      list.innerHTML = "";

      if (!players.length) {
        document.getElementById("player-rank").textContent = "Be the first on the leaderboard üëÄ";
        return;
      }

      let yourRank = null;

      players.forEach((p, index) => {
        if (p.id === PLAYER_ID) yourRank = index + 1;

        const item = document.createElement("div");
        item.className = `leaderboard-item ${p.id === PLAYER_ID ? "you" : ""}`;

        let rankClass = "";
        if (index === 0) rankClass = "gold";
        else if (index === 1) rankClass = "silver";
        else if (index === 2) rankClass = "bronze";

        const displayBalance = currentLeaderboardMode === 'daily'
          ? (p.dailyBalance || 0)
          : (p.balance || 0);

        item.innerHTML = `
          <div class="leaderboard-rank ${rankClass}">#${index + 1}</div>
          <div class="leaderboard-name">${sanitizeName(p.name || "Anonymous")}</div>
          <div class="leaderboard-balance">${moneyFormat.format(Number(displayBalance))}</div>
        `;

        list.appendChild(item);
      });

      const msg = document.getElementById("player-rank");
      const modeText = currentLeaderboardMode === 'daily' ? "today's leaderboard" : "the all-time leaderboard";
      msg.textContent = yourRank
        ? `You're #${yourRank} on ${modeText}.`
        : `Not in top 10 yet on ${modeText} ‚Äî keep earning!`;
    }

    // =========================
    // SHARE / REFERRALS / ANALYTICS
    // =========================
    const SHARE_URL = "https://shungtai.com";
    const FB_PAGE_URL = "https://web.facebook.com/profile.php?id=61587482075467";

    function openCenteredPopup(url, w = 550, h = 520) {
      const dualScreenLeft = window.screenLeft !== undefined ? window.screenLeft : window.screenX;
      const dualScreenTop = window.screenTop !== undefined ? window.screenTop : window.screenY;
      const width = window.innerWidth ? window.innerWidth : document.documentElement.clientWidth ? document.documentElement.clientWidth : screen.width;
      const height = window.innerHeight ? window.innerHeight : document.documentElement.clientHeight ? document.documentElement.clientHeight : screen.height;
      const left = ((width / 2) - (w / 2)) + dualScreenLeft;
      const top = ((height / 2) - (h / 2)) + dualScreenTop;
      const features = `scrollbars=yes,width=${w},height=${h},top=${top},left=${left}`;
      window.open(url, '_blank', features);
    }

    function facebookShareUrl(url, quoteText = "") {
      return `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(url)}${quoteText ? `&quote=${encodeURIComponent(quoteText)}` : ""}`;
    }

    function copyToClipboard(text) {
      return navigator.clipboard.writeText(text).then(() => true).catch(() => false);
    }

    // ============================================
    // REFERRAL SYSTEM (NEW)
    // ============================================
    function getReferralCode() {
      let code = localStorage.getItem("cf_referral_code");
      if (!code) {
        code = Math.random().toString(36).substring(2, 8).toUpperCase();
        localStorage.setItem("cf_referral_code", code);
      }
      return code;
    }

    function getReferredBy() {
      const urlParams = new URLSearchParams(window.location.search);
      const ref = urlParams.get('ref');
      if (ref) {
        const existing = localStorage.getItem("cf_referred_by");
        if (!existing) {
          localStorage.setItem("cf_referred_by", ref);
          trackReferral(ref);
          return ref;
        }
        return existing;
      }
      return localStorage.getItem("cf_referred_by");
    }

    function trackReferral(referrerCode) {
      const referrals = JSON.parse(localStorage.getItem("cf_my_referrals") || "[]");
      if (!referrals.includes(referrerCode)) {
        referrals.push(referrerCode);
        localStorage.setItem("cf_my_referrals", JSON.stringify(referrals));
      }

      if (typeof trackEvent === 'function') {
        trackEvent('Referral', 'new_user_referred', referrerCode);
      }
    }

    function copyReferralLink() {
      const myCode = getReferralCode();
      const link = `${SHARE_URL}?ref=${myCode}`;

      copyToClipboard(link).then(ok => {
        if (ok) {
          alert(`üéÅ Referral link copied!\n\n${link}\n\nShare this with friends.`);
          if (typeof trackEvent === 'function') {
            trackEvent('Referral', 'copy_link', myCode);
          }
        } else {
          prompt("Copy your referral link:", link);
        }
      });
    }

    function updateReferralDisplay() {
      const referrals = JSON.parse(localStorage.getItem("cf_my_referrals") || "[]");
      const countEl = document.getElementById("referral-count");
      if (countEl) {
        const count = referrals.length;
        countEl.textContent = count === 0 ? "0 friends referred" :
                             count === 1 ? "1 friend referred" :
                             `${count} friends referred`;
      }
    }

    window.copyReferralLink = copyReferralLink;

    function buildShareCaption(type) {
      const balanceText = document.getElementById('balance') ? document.getElementById('balance').textContent : "$0.00";
      const rankText = document.getElementById('player-rank') ? document.getElementById('player-rank').textContent : "";
      const tipText = document.getElementById('tip-text') ? document.getElementById('tip-text').textContent : "";
      const name = sanitizeName(USERNAME);

      const myRef = getReferralCode();
      const refLink = `${SHARE_URL}?ref=${myRef}`;

      if (type === "millionaire") {
        return `üèÜ I hit $1,000,000 on Couch Funds! üõãÔ∏èüëë\n\nName: ${name}\nNet Worth: ${balanceText}\n\nPlay here: ${refLink}\nFollow the page: ${FB_PAGE_URL}`;
      }
      if (type === "hustle") {
        const idea = document.getElementById('hustle-idea') ? document.getElementById('hustle-idea').textContent : "Secret Hustle";
        return `üîì I unlocked a Secret Hustle on Couch Funds! üõãÔ∏èüí∞\n\nHustle: ${idea}\nName: ${name}\nNet Worth: ${balanceText}\n\nPlay: ${refLink}\nFollow: ${FB_PAGE_URL}`;
      }
      if (type === "rank") {
        return `üèÜ Couch Funds Leaderboard Update\n\n${rankText}\nName: ${name}\nNet Worth: ${balanceText}\n\nPlay: ${refLink}\nFollow: ${FB_PAGE_URL}`;
      }
      if (type === "tip") {
        return `üí° Couch Funds Money Tip\n\n"${tipText}"\n\nPlay: ${refLink}\nFollow: ${FB_PAGE_URL}`;
      }
      return `Couch Funds üõãÔ∏èüí∞\nPlay: ${refLink}\nFollow: ${FB_PAGE_URL}`;
    }

    // FIXED: no recursion; everything calls these
    window.shareSiteToFacebook = async () => {
      const caption = buildShareCaption("site");
      await copyToClipboard(caption);

      if (typeof trackEvent === 'function') {
        trackEvent('Share', 'facebook_site', 'hero_button');
      }

      openCenteredPopup(facebookShareUrl(SHARE_URL, caption));
    };

    async function shareLeaderboardToFacebook() {
      const caption = buildShareCaption("rank");
      await copyToClipboard(caption);

      if (typeof trackEvent === 'function') {
        trackEvent('Share', 'facebook_rank', currentLeaderboardMode);
      }

      openCenteredPopup(facebookShareUrl(SHARE_URL, caption));
    }

    function shareLeaderboardToWhatsApp() {
      const caption = buildShareCaption("rank");
      const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(caption)}`;
      window.open(whatsappUrl, '_blank');
    }

    async function shareTipToFacebook() {
      const caption = buildShareCaption("tip");
      await copyToClipboard(caption);
      openCenteredPopup(facebookShareUrl(SHARE_URL, caption));
    }

    function shareTipToWhatsApp() {
      const caption = buildShareCaption("tip");
      const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(caption)}`;
      window.open(whatsappUrl, '_blank');
    }

    async function shareWinToFacebook() {
      const caption = buildShareCaption("millionaire");
      await copyToClipboard(caption);
      openCenteredPopup(facebookShareUrl(SHARE_URL, caption));
    }

    async function shareHustleToFacebook() {
      const caption = buildShareCaption("hustle");
      await copyToClipboard(caption);

      if (typeof trackEvent === 'function') {
        trackEvent('Share', 'facebook_hustle', 'secret_unlock');
      }

      openCenteredPopup(facebookShareUrl(SHARE_URL, caption));
    }

    function shareToWhatsApp(type) {
      const caption = buildShareCaption(type);
      const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(caption)}`;
      window.open(whatsappUrl, '_blank');
    }

    function shareToTwitter(type) {
      const caption = buildShareCaption(type);
      const twitterUrl = `https://twitter.com/intent/tweet?text=${encodeURIComponent(caption)}`;

      if (typeof trackEvent === 'function') {
        trackEvent('Share', 'twitter', type);
      }

      openCenteredPopup(twitterUrl, 560, 440);
    }

    async function copyShareText(type) {
      const text = buildShareCaption(type);
      const ok = await copyToClipboard(text);

      if (typeof trackEvent === 'function') {
        trackEvent('Share', 'copy_caption', type);
      }

      alert(ok ? "Caption copied. Paste it into your Facebook post/story." : "Copy failed. Select text manually and copy.");
    }

    async function copyPageLink() {
      const ok = await copyToClipboard(FB_PAGE_URL);
      alert(ok ? "Facebook page link copied." : "Copy failed. Please copy the link manually.");
    }

    window.shareLeaderboardToFacebook = shareLeaderboardToFacebook;
    window.shareTipToFacebook = shareTipToFacebook;
    window.shareWinToFacebook = shareWinToFacebook;
    window.shareHustleToFacebook = shareHustleToFacebook;
    window.shareLeaderboardToWhatsApp = shareLeaderboardToWhatsApp;
    window.shareToTwitter = shareToTwitter;

    // =========================
    // SECRET HUSTLES (unchanged except tracking hooks)
    // =========================
    let currentHustle = null;

    const secretHustles = [
      {
        idea: "AI Children's Book Empire",
        tools: "Claude (Writing), Midjourney (Art)",
        platform: "Amazon KDP",
        action: "Publish consistent character stories without drawing a single line.",
        steps: [
          "Ask Claude 3.0: 'Write a 24-page rhyming children's story (AABB rhyme scheme) about a [Topic] for 3-5 year olds.'",
          "Open Midjourney. Create a character sheet first to ensure consistency. Use the same seed number (--seed 1234) for every subsequent prompt.",
          "Generate 12-14 illustrations (one per spread). Prompt style: 'watercolor style, cute, pastel colors, white background'.",
          "Use a free upscaler like BigJPG to increase image resolution to 300 DPI (essential for print).",
          "Go to Canva. Search 'KDP Book 8.5x8.5'. Upload text on one side, image on the other.",
          "Download as 'PDF Print' and upload to Amazon KDP. Set royalties to 60%."
        ]
      },
      {
        idea: "Faceless Lofi Channels",
        tools: "Suno AI (Music), Midjourney (Visuals)",
        platform: "YouTube",
        action: "Create 24/7 study music streams or 1-hour loops for passive ad revenue.",
        steps: [
          "Go to Suno.ai or Udio. Prompt: 'lofi hip hop, chill, instrumental, study beats, no lyrics'. Generate 10 songs.",
          "Download the tracks and stitch them together in CapCut or DaVinci Resolve to make a 1-hour loop.",
          "Generate a 16:9 image in Midjourney: 'cozy anime bedroom, raining window, lofi aesthetic, night time --ar 16:9'.",
          "Use 'LeiaPix' or 'RunwayML' to add slight motion to the image (like moving rain or candle flicker).",
          "Upload to YouTube. Title for SEO: 'Lofi Beats to Study/Relax To 2026'.",
          "Once monetized, this earns passive ad revenue forever."
        ]
      },
      {
        idea: "Viral History Shorts",
        tools: "ChatGPT (Script), ElevenLabs (Voice)",
        platform: "TikTok / YouTube Shorts",
        action: "Mass-produce 'Did You Know?' history facts videos.",
        steps: [
          "Ask ChatGPT: 'Give me 5 crazy, lesser-known historical facts about the Roman Empire that are shocking'.",
          "Take the script to ElevenLabs. Use the 'Adam' or 'Antoni' voice for a narrator vibe.",
          "Import audio into CapCut. Use the 'Auto-Captions' feature to put big, colorful text on screen (Alex Hormozi style).",
          "Overlay stock footage or AI images related to the fact.",
          "Post the same video to TikTok, Instagram Reels, and YouTube Shorts simultaneously."
        ]
      },
      {
        idea: "Kawaii Sticker Shop",
        tools: "Midjourney (--tile), Adobe Express",
        platform: "Redbubble / Etsy",
        action: "Sell cute physical stickers without holding any inventory.",
        steps: [
          "Go to Midjourney. Prompt: 'cute kawaii sushi sticker, white background, bold black outline, vector style, flat color'.",
          "Upscale your favorite result.",
          "Upload the image to Adobe Express (Free) or Remove.bg to delete the white background transparently.",
          "Create a Redbubble account. Upload the design.",
          "Enable 'Stickers' and 'Magnets'. Set your margin to 50%.",
          "Use tags like: 'planner stickers', 'laptop decal', 'cute aesthetic'."
        ]
      }
      // (rest of your hustles can stay the same)
    ];

    function unlockSecretHustle() {
      if (!secretHustles.length) return;

      currentHustle = secretHustles[Math.floor(Math.random() * secretHustles.length)];
      document.getElementById('hustle-idea').textContent = currentHustle.idea;
      document.getElementById('hustle-tools').textContent = `${currentHustle.tools} ‚Üí ${currentHustle.platform}`;
      document.getElementById('hustle-modal').style.display = 'flex';

      if (typeof trackEvent === 'function') {
        trackEvent('Game', 'unlock_hustle', currentHustle.idea);
      }
    }

    function openDeepDive() {
      closeModal('hustle-modal');

      document.getElementById('dossier-id').textContent = String(Math.floor(Math.random() * 900) + 100).padStart(3, '0');
      document.getElementById('dossier-title').textContent = "OPERATION: " + String(currentHustle.idea || "UNKNOWN").toUpperCase();

      const stepsContainer = document.getElementById('dossier-steps');
      stepsContainer.innerHTML = "";

      (currentHustle.steps || []).forEach((step, index) => {
        const stepRow = document.createElement('div');
        stepRow.className = 'checklist-item';
        stepRow.innerHTML = `
          <span class="checklist-number">${String(index + 1).padStart(2, '0')} //</span>
          <span>${step}</span>
        `;
        stepsContainer.appendChild(stepRow);
      });

      document.getElementById('deep-dive-modal').style.display = 'flex';
    }

    function copyDossier(evt) {
      if (!currentHustle) return;

      let text = `CONFIDENTIAL HUSTLE: ${currentHustle.idea}\n\n`;
      text += `TOOLS: ${currentHustle.tools}\n`;
      text += `PLATFORM: ${currentHustle.platform}\n\n`;
      text += `EXECUTION STEPS:\n`;
      (currentHustle.steps || []).forEach((step, i) => {
        text += `${i + 1}. ${step}\n`;
      });
      text += `\nUnlocked via Couch Funds - ${SHARE_URL}\nFacebook: ${FB_PAGE_URL}`;

      navigator.clipboard.writeText(text).then(() => {
        if (typeof trackEvent === 'function') {
          trackEvent('Game', 'copy_dossier', currentHustle.idea);
        }

        const btn = evt?.target;
        if (!btn) return;
        const originalText = btn.textContent;
        btn.textContent = "‚úÖ COPIED TO CLIPBOARD";
        btn.classList.add('copied');
        setTimeout(() => {
          btn.textContent = originalText;
          btn.classList.remove('copied');
        }, 2000);
      }).catch(() => {
        alert('Failed to copy. Please try again.');
      });
    }

    // =========================
    // TIC TAC TOE (with tracking on win)
    // =========================
    let board = ["", "", "", "", "", "", "", "", ""];
    const player = "X";
    const ai = "O";
    let gameActive = true;
    const tttBoard = document.getElementById("ttt-board");
    const tttStatus = document.getElementById("ttt-status");

    function initTTT() {
      tttBoard.innerHTML = "";
      board.forEach((cell, i) => {
        const div = document.createElement("div");
        div.className = "ttt-cell";
        div.dataset.index = i;
        div.textContent = cell;
        if (cell) div.classList.add(cell.toLowerCase());
        if (!checkWinner(board) && gameActive) {
          div.onclick = () => handleMove(i);
        }
        tttBoard.appendChild(div);
      });
    }

    function handleMove(i) {
      if (board[i] || checkWinner(board) || !gameActive) return;

      board[i] = player;
      initTTT();

      const winner = checkWinner(board);
      if (winner || !board.includes("")) {
        updateStatus();
        return;
      }

      tttStatus.textContent = "Market is thinking...";
      setTimeout(aiMove, 600);
    }

    function aiMove() {
      let move;

      if (Math.random() < 0.30) {
        let available = board.map((v, i) => v === "" ? i : null).filter(v => v !== null);
        move = available[Math.floor(Math.random() * available.length)];
      } else {
        move = getBestMove();
      }

      board[move] = ai;
      initTTT();
      updateStatus();
    }

    function updateStatus() {
      const win = checkWinner(board);
      if (win === "X") {
        tttStatus.textContent = "üèÜ You beat the Market!";
        gameActive = false;
        gameState.hasBeatenAI = true;

        if (typeof trackEvent === 'function') {
          trackEvent('Game', 'win_tictactoe', 'player_victory');
        }

        checkAchievements();
        setTimeout(unlockSecretHustle, 800);
      }
      else if (win === "O") {
        tttStatus.textContent = "üìâ Market Volatility won.";
        gameActive = false;
      }
      else if (!board.includes("")) {
        tttStatus.textContent = "ü§ù It's a Market Draw.";
        gameActive = false;
      }
      else {
        tttStatus.textContent = "Your move, Investor.";
      }
    }

    function checkWinner(b) {
      const lines = [[0,1,2],[3,4,5],[6,7,8],[0,3,6],[1,4,7],[2,5,8],[0,4,8],[2,4,6]];
      for (let l of lines) {
        if (b[l[0]] && b[l[0]] === b[l[1]] && b[l[0]] === b[l[2]]) return b[l[0]];
      }
      return null;
    }

    function getBestMove() {
      let bestScore = -Infinity;
      let move;
      for (let i = 0; i < 9; i++) {
        if (board[i] === "") {
          board[i] = ai;
          let score = minimax(board, 0, false);
          board[i] = "";
          if (score > bestScore) {
            bestScore = score;
            move = i;
          }
        }
      }
      return move;
    }

    function minimax(b, depth, isMaximizing) {
      let result = checkWinner(b);
      if (result === ai) return 10 - depth;
      if (result === player) return depth - 10;
      if (!b.includes("")) return 0;

      if (isMaximizing) {
        let bestScore = -Infinity;
        for (let i = 0; i < 9; i++) {
          if (b[i] === "") {
            b[i] = ai;
            bestScore = Math.max(bestScore, minimax(b, depth + 1, false));
            b[i] = "";
          }
        }
        return bestScore;
      } else {
        let bestScore = Infinity;
        for (let i = 0; i < 9; i++) {
          if (b[i] === "") {
            b[i] = player;
            bestScore = Math.min(bestScore, minimax(b, depth + 1, true));
            b[i] = "";
          }
        }
        return bestScore;
      }
    }

    function resetTTT() {
      board = ["", "", "", "", "", "", "", "", ""];
      gameActive = true;
      tttStatus.textContent = "Your move, Investor.";
      initTTT();
    }

    // =========================
    // GAME STATE (unchanged core)
    // =========================
    const GOAL_AMOUNT = 1000000;
    const SAVE_KEY = "couchPotatoTycoon_V5";
    const LEGACY_SAVE_KEYS = ["couchPotatoTycoon_V4"];
    const PRESTIGE_LEVEL_KEY = "cf_prestige_level";
    const PRESTIGE_BONUS_KEY = "cf_prestige_bonus";
    let gameLoopInterval = null;
    const sessionStart = Date.now();
    let lastMilestone = 0;
    let isResetting = false;

    let gameState = {
      balance: 0.00,
      income: 0.00,
      clickValue: 1.00,
      hasWon: false,
      lastSaveTime: Date.now(),
      totalClicks: 0,
      totalUpgrades: 0,
      hasBeatenAI: false,
      unlockedAchievements: [],
      streak: 0,
      lastVisitDate: '',
      firstPlayTime: Date.now(),
      prestigeLevel: 0,
      prestigeBonus: 1.0,
      soundEnabled: true,
      upgrades: [
        { id: 0, name: "Loose Change", cost: 15, income: 0.5, count: 0, icon: "ü™ô", baseCost: 15 },
        { id: 1, name: "Piggy Bank", cost: 100, income: 4, count: 0, icon: "üê∑", baseCost: 100 },
        { id: 2, name: "Lemonade Stand", cost: 1100, income: 12, count: 0, icon: "üçã", baseCost: 1100 },
        { id: 3, name: "Vending Machine", cost: 12000, income: 48, count: 0, icon: "üç´", baseCost: 12000 },
        { id: 4, name: "ATM", cost: 130000, income: 240, count: 0, icon: "üèß", baseCost: 130000 },
        { id: 5, name: "Bank Branch", cost: 1400000, income: 960, count: 0, icon: "üè¶", baseCost: 1400000 }
      ]
    };

    const tips = [
      "The best time to plant a money tree was 20 years ago. The second best time is today.",
      "Compound interest is the eighth wonder of the world. He who understands it, earns it.",
      "Wealth isn't about having a lot of money; it's about having a lot of options.",
      "Don't save what is left after spending; spend what is left after saving.",
      "A budget is telling your money where to go instead of wondering where it went.",
      "Rich people stay rich by living like they're broke. Broke people stay broke by living like they're rich.",
      "Passive income is the only true financial freedom.",
      "Invest in yourself. Your knowledge is the engine of your wealth.",
      "Automate your savings. Willpower is a limited resource.",
      "The goal is not to look rich, the goal is to be rich.",
      "Do not wait to buy real estate. Buy real estate and wait.",
      "Your network is your net worth.",
      "Time in the market beats timing the market.",
      "Assets put money in your pocket. Liabilities take money out of your pocket.",
      "Don't trade your time for money forever. Trade your money for time.",
      "Price is what you pay. Value is what you get.",
      "A penny saved is a penny earned.",
      "The rich invest in time, the poor invest in money.",
      "If you can't buy it twice, you can't afford it.",
      "Money is a terrible master but an excellent servant.",
      "Track your net worth, not just your salary.",
      "An investment in knowledge pays the best interest.",
      "Live below your means, but expand your means."
    ];

    function getTipOfTheDay() {
      const dayOfYear = Math.floor((new Date() - new Date(new Date().getFullYear(), 0, 0)) / (1000 * 60 * 60 * 24));
      return tips[dayOfYear % tips.length];
    }

    function renderTip(text) {
      const el = document.getElementById('tip-text');
      el.classList.remove('fade-in');
      void el.offsetWidth;
      el.textContent = text;
      el.classList.add('fade-in');
    }

    function showRandomTip() {
      renderTip(tips[Math.floor(Math.random() * tips.length)]);
    }

    const moneyFormat = new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', minimumFractionDigits: 2 });
    const balanceEl = document.getElementById('balance');
    const incomeEl = document.getElementById('income-display');
    const progressFill = document.getElementById('progress-fill');
    const progressTextEl = document.getElementById('progress-text');
    const progressPercentEl = document.getElementById('progress-percent');

    let audioCtx = null;
    function ensureAudioContext() {
      if (!audioCtx) {
        const Ctx = window.AudioContext || window.webkitAudioContext;
        if (!Ctx) return null;
        audioCtx = new Ctx();
      }
      if (audioCtx.state === 'suspended') audioCtx.resume().catch(() => {});
      return audioCtx;
    }

    function playSound(type) {
      if (gameState.soundEnabled === false) return;
      const ctx = ensureAudioContext();
      if (!ctx) return;

      const osc = ctx.createOscillator();
      const gain = ctx.createGain();
      const map = {
        click: { f: 420, d: 0.035, v: 0.03 },
        buy: { f: 560, d: 0.08, v: 0.05 },
        win: { f: 760, d: 0.18, v: 0.07 }
      };
      const cfg = map[type] || map.click;

      osc.type = 'triangle';
      osc.frequency.value = cfg.f;
      gain.gain.value = cfg.v;
      osc.connect(gain);
      gain.connect(ctx.destination);
      osc.start();
      osc.stop(ctx.currentTime + cfg.d);
    }

    function addMuteButton() {
      if (document.getElementById('mute-btn')) return;
      const btn = document.createElement('button');
      btn.id = 'mute-btn';
      btn.className = 'mute-btn';
      btn.setAttribute('aria-label', 'Toggle sound');
      btn.textContent = gameState.soundEnabled === false ? 'üîá' : 'üîä';
      btn.addEventListener('click', () => {
        gameState.soundEnabled = !(gameState.soundEnabled === false);
        btn.textContent = gameState.soundEnabled ? 'üîä' : 'üîá';
        saveGame(true);
      });
      document.body.appendChild(btn);
    }

    function loadGame() {
      let saved = localStorage.getItem(SAVE_KEY);
      let loadedFromLegacy = false;

      if (!saved) {
        for (const legacyKey of LEGACY_SAVE_KEYS) {
          const legacySaved = localStorage.getItem(legacyKey);
          if (legacySaved) {
            saved = legacySaved;
            loadedFromLegacy = true;
            break;
          }
        }
      }

      if (saved) {
        try {
          const loadedState = JSON.parse(saved);
          Object.assign(gameState, loadedState);
          // No offline catch-up: income only accrues while the page is actively open.
          gameState.lastSaveTime = Date.now();

          if (loadedState.upgrades) {
            gameState.upgrades.forEach((u, i) => {
              if (loadedState.upgrades[i]) {
                u.count = loadedState.upgrades[i].count || 0;
                u.cost = Math.floor(u.baseCost * Math.pow(1.15, u.count));
              }
            });
          }

          if (loadedFromLegacy) {
            localStorage.setItem(SAVE_KEY, JSON.stringify(gameState));
          }
        } catch (e) {
          console.error('Error loading save:', e);
        }
      }

      if (!gameState.firstPlayTime) gameState.firstPlayTime = Date.now();
      if (typeof gameState.soundEnabled !== "boolean") gameState.soundEnabled = true;
      gameState.lastVisitDate = normalizeStoredDateKey(gameState.lastVisitDate);

      const storedPrestigeLevel = parseInt(localStorage.getItem(PRESTIGE_LEVEL_KEY) || "0", 10);
      const storedPrestigeBonus = parseFloat(localStorage.getItem(PRESTIGE_BONUS_KEY) || "1");
      if (!Number.isFinite(gameState.prestigeLevel) || gameState.prestigeLevel < storedPrestigeLevel) {
        gameState.prestigeLevel = Math.max(0, storedPrestigeLevel);
      }
      if (!Number.isFinite(gameState.prestigeBonus) || gameState.prestigeBonus < storedPrestigeBonus) {
        gameState.prestigeBonus = Math.max(1, storedPrestigeBonus);
      }
      localStorage.setItem(PRESTIGE_LEVEL_KEY, String(gameState.prestigeLevel || 0));
      localStorage.setItem(PRESTIGE_BONUS_KEY, String(gameState.prestigeBonus || 1));

      const balanceInt = Math.max(0, Math.floor(gameState.balance));
      lastDirtyBalance = balanceInt;
      lastSyncedBalance = balanceInt;
      lastMilestone = [100, 1000, 10000, 100000, 500000, 1000000].filter(m => balanceInt >= m).pop() || 0;
      lastPublishedMilestone = LEADERBOARD_PUBLISH_MILESTONES.filter(m => balanceInt >= m).pop() || 0;

      recalcIncome();
      updateStreak();
      renderAchievements();
    }

    function saveGame(force = false) {
      if (isResetting) return;
      if (!force && !gameLoopInterval) return;
      gameState.lastSaveTime = Date.now();
      try {
        localStorage.setItem(SAVE_KEY, JSON.stringify(gameState));
      } catch (e) {
        console.error('Error saving:', e);
      }
    }

    function hardReset() {
      if (!confirm("‚ö†Ô∏è RESET WARNING ‚ö†Ô∏è\n\nAre you sure you want to delete your save file and start over? This cannot be undone.")) {
        return;
      }

      if (gameLoopInterval) {
        clearInterval(gameLoopInterval);
        gameLoopInterval = null;
      }
      if (saveLoopInterval) {
        clearInterval(saveLoopInterval);
        saveLoopInterval = null;
      }
      if (leaderboardSyncInterval) {
        clearInterval(leaderboardSyncInterval);
        leaderboardSyncInterval = null;
      }
      if (leaderboardPublishTimer) {
        clearTimeout(leaderboardPublishTimer);
        leaderboardPublishTimer = null;
      }
      stopLeaderboardPolling();

      // Keep username/player identity lock, reset gameplay progress.
      isResetting = true;
      localStorage.removeItem(SAVE_KEY);
      LEGACY_SAVE_KEYS.forEach(k => localStorage.removeItem(k));
      localStorage.removeItem('cf_referral_code');
      localStorage.removeItem('cf_referred_by');
      localStorage.removeItem('cf_my_referrals');
      localStorage.removeItem(DAILY_REWARD_KEY);
      localStorage.removeItem(DAILY_LEADERBOARD_RESET_KEY);
      localStorage.removeItem(PRESTIGE_LEVEL_KEY);
      localStorage.removeItem(PRESTIGE_BONUS_KEY);
      location.reload();
    }

    function prestigeReset() {
      if (gameState.balance < GOAL_AMOUNT) {
        alert("You need $1,000,000 to prestige.");
        return;
      }

      const prestigeGain = Math.max(1, Math.floor(gameState.balance / GOAL_AMOUNT));
      gameState.prestigeLevel = Math.max(0, gameState.prestigeLevel || 0) + prestigeGain;
      gameState.prestigeBonus = 1 + (gameState.prestigeLevel * 0.1);
      localStorage.setItem(PRESTIGE_LEVEL_KEY, String(gameState.prestigeLevel));
      localStorage.setItem(PRESTIGE_BONUS_KEY, String(gameState.prestigeBonus));
      isResetting = true;

      if (gameLoopInterval) {
        clearInterval(gameLoopInterval);
        gameLoopInterval = null;
      }
      if (saveLoopInterval) {
        clearInterval(saveLoopInterval);
        saveLoopInterval = null;
      }
      if (leaderboardSyncInterval) {
        clearInterval(leaderboardSyncInterval);
        leaderboardSyncInterval = null;
      }
      if (leaderboardPublishTimer) {
        clearTimeout(leaderboardPublishTimer);
        leaderboardPublishTimer = null;
      }
      if (leaderboardUnsubscribe) {
        leaderboardUnsubscribe();
        leaderboardUnsubscribe = null;
      }
      localStorage.removeItem(SAVE_KEY);
      LEGACY_SAVE_KEYS.forEach(k => localStorage.removeItem(k));
      location.reload();
    }

    function recalcIncome() {
      let totalIncome = 0;
      gameState.upgrades.forEach(u => totalIncome += u.income * u.count);
      totalIncome *= Math.max(1, gameState.prestigeBonus || 1);
      gameState.income = totalIncome;
      incomeEl.textContent = `+${moneyFormat.format(totalIncome)} / sec`;
      if ((gameState.prestigeLevel || 0) > 0) {
        incomeEl.textContent += ` (‚≠ê${gameState.prestigeLevel})`;
      }
    }

    function initStore() {
      const grid = document.getElementById('store-grid');
      grid.innerHTML = '';
      gameState.upgrades.forEach((u, index) => {
        const card = document.createElement('div');
        card.id = `upgrade-card-${index}`;
        card.className = 'upgrade-card disabled';
        card.innerHTML = `
          <div class="upgrade-count" id="count-${index}">${u.count}</div>
          <span class="upgrade-name">${u.icon} ${u.name}</span>
          <span class="upgrade-cost" id="cost-${index}">${moneyFormat.format(u.cost)}</span>
          <span class="upgrade-rate">+${u.income}/s</span>
          <div style="margin-top:8px; display:flex; gap:6px;">
            <button data-buy="1" style="flex:1; padding:6px; border-radius:6px; border:1px solid rgba(255,255,255,0.2); background:transparent; color:var(--accent-green); cursor:pointer; font-size:0.75rem;">Buy 1</button>
            <button data-buy="10" style="flex:1; padding:6px; border-radius:6px; border:1px solid rgba(255,255,255,0.2); background:transparent; color:var(--accent-gold); cursor:pointer; font-size:0.75rem;">Buy 10</button>
            <button data-buy="max" style="flex:1; padding:6px; border-radius:6px; border:1px solid rgba(255,255,255,0.2); background:transparent; color:var(--accent-purple); cursor:pointer; font-size:0.75rem;">Max</button>
          </div>
        `;
        card.onclick = () => buyUpgrade(index, 1);
        card.querySelectorAll('button[data-buy]').forEach(btn => {
          btn.addEventListener('click', (evt) => {
            evt.stopPropagation();
            const mode = btn.getAttribute('data-buy');
            if (mode === 'max') {
              buyMaxUpgrade(index);
            } else {
              buyUpgrade(index, Number(mode || 1));
            }
          });
        });
        grid.appendChild(card);
      });
    }

    function updateUI() {
      balanceEl.textContent = moneyFormat.format(gameState.balance);

      let percentage = Math.min((gameState.balance / GOAL_AMOUNT) * 100, 100);
      if (gameState.balance > 0) percentage = Math.max(percentage, 0.3);
      progressFill.style.width = `${percentage}%`;

      progressTextEl.textContent = `${moneyFormat.format(gameState.balance)} / ${moneyFormat.format(GOAL_AMOUNT)}`;
      progressPercentEl.innerHTML = `<b>${Math.min((gameState.balance / GOAL_AMOUNT) * 100, 100).toFixed(1)}%</b>`;

      if (gameState.balance >= GOAL_AMOUNT && !gameState.hasWon) {
        triggerWin();
      }

      gameState.upgrades.forEach((u, index) => {
        const card = document.getElementById(`upgrade-card-${index}`);
        const countEl = document.getElementById(`count-${index}`);
        const costEl = document.getElementById(`cost-${index}`);

        if (card) {
          if (gameState.balance >= u.cost) card.classList.remove('disabled');
          else card.classList.add('disabled');
        }

        if (countEl) countEl.textContent = u.count;
        if (costEl) costEl.textContent = moneyFormat.format(u.cost);
      });

      checkAchievements();
      const balanceInt = Math.max(0, Math.floor(gameState.balance));

      const milestones = [100, 1000, 10000, 100000, 500000, 1000000];
      const reached = milestones.filter(m => balanceInt >= m).pop() || 0;
      if (reached > lastMilestone) {
        lastMilestone = reached;
        if (LEADERBOARD_PUBLISH_MILESTONES.includes(reached) && reached > lastPublishedMilestone) {
          lastPublishedMilestone = reached;
          queueLeaderboardPublish("milestone");
        }
        if (typeof trackEvent === 'function') {
          trackEvent('Progression', 'milestone', `$${reached}`);
        }
      }
    }

    function buyUpgrade(index, quantity = 1) {
      const u = gameState.upgrades[index];
      let bought = 0;

      for (let i = 0; i < quantity; i++) {
        if (gameState.balance >= u.cost) {
          gameState.balance -= u.cost;
          u.count++;
          u.cost = Math.floor(u.baseCost * Math.pow(1.15, u.count));
          gameState.totalUpgrades++;
          bought++;
        } else {
          break;
        }
      }

      if (bought > 0) {
        if (typeof trackEvent === 'function') {
          trackEvent('Economy', 'buy_upgrade', `${u.name} x${bought}`);
        }
        queueLeaderboardPublish("buy_upgrade");
        recalcIncome();
        updateUI();
        playSound('buy');
        saveGame();
      }
    }

    function buyMaxUpgrade(index) {
      const u = gameState.upgrades[index];
      let bought = 0;

      while (gameState.balance >= u.cost && bought < 200) {
        gameState.balance -= u.cost;
        u.count++;
        u.cost = Math.floor(u.baseCost * Math.pow(1.15, u.count));
        gameState.totalUpgrades++;
        bought++;
      }

      if (bought > 0) {
        if (typeof trackEvent === 'function') {
          trackEvent('Economy', 'buy_upgrade_max', `${u.name} x${bought}`);
        }
        queueLeaderboardPublish("buy_upgrade_max");
        recalcIncome();
        updateUI();
        playSound('buy');
        saveGame();
      }
    }
    window.buyMaxUpgrade = buyMaxUpgrade;

    function spawnFloatingText(amount, x, y) {
      const el = document.createElement('div');
      el.className = 'floating-text';
      el.textContent = `+${moneyFormat.format(amount)}`;
      el.style.left = `${x}px`;
      el.style.top = `${y}px`;
      document.body.appendChild(el);
      setTimeout(() => el.remove(), 800);
    }

    document.getElementById('click-btn').addEventListener('click', (e) => {
      gameState.balance += gameState.clickValue;
      gameState.totalClicks++;
      updateUI();
      playSound('click');

      const rect = e.target.getBoundingClientRect();
      const x = e.clientX || (rect.left + rect.width / 2);
      const y = e.clientY || (rect.top + rect.height / 2);
      spawnFloatingText(gameState.clickValue, x, y);

      if (typeof trackEvent === 'function') {
        trackEvent('Game', 'click', 'couch');
      }

      saveGame();
    });

    function triggerWin() {
      gameState.hasWon = true;
      document.getElementById('win-modal').style.display = 'flex';
      checkAchievements();
      playSound('win');

      if (typeof trackEvent === 'function') {
        trackEvent('Game', 'win_millionaire', 'goal_reached');
      }

      saveGame();
    }

    function closeModal(id) {
      document.getElementById(id).style.display = 'none';
    }

    function bootFirebaseConnections() {
      const rankEl = document.getElementById("player-rank");
      if (rankEl) rankEl.textContent = "Connecting to leaderboard...";
      setLeaderboardLoadButtonState();

      const initPromise = window.__firebaseInitPromise || Promise.resolve(false);

      initPromise.then(async (ok) => {
        USERNAME = await initUsername();

        if (!ok || !window.__FIREBASE__) {
          if (rankEl) rankEl.textContent = "Leaderboard not connected (Firebase failed to load).";
          const btn = document.getElementById("load-leaderboard-btn");
          if (btn) {
            btn.disabled = true;
            btn.textContent = "Leaderboard Offline";
          }
          return;
        }

        if (typeof isFirestoreDisabled === "function" && isFirestoreDisabled()) {
          if (rankEl) rankEl.textContent = "Leaderboard paused (quota exceeded). Try again later.";
          setLeaderboardLoadButtonState();
          return;
        }

        await checkDailyLeaderboardReset();
        setLeaderboardStatus('Click "View Leaderboard" to load rankings.');
        setLeaderboardLoadButtonState();
      }).catch(async (err) => {
        if (!USERNAME) {
          try { USERNAME = await initUsername(); } catch {}
        }
        console.error("Firebase boot error:", err);
        if (rankEl) rankEl.textContent = "Leaderboard offline.";
        const btn = document.getElementById("load-leaderboard-btn");
        if (btn) {
          btn.disabled = true;
          btn.textContent = "Leaderboard Offline";
        }
      });
    }

    // =========================
    // BOOT
    // =========================
    document.addEventListener('DOMContentLoaded', () => {
      renderTip(getTipOfTheDay());
      initTTT();
      initStore();
      loadGame();
      updateUI();
      checkDailyReward();
      addMuteButton();

      // Referral init (NEW)
      getReferredBy();
      updateReferralDisplay();

      const isMobile = /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
      const loopInterval = isMobile ? 500 : 100;
      const loopDivider = isMobile ? 2 : 10;

      gameLoopInterval = setInterval(() => {
        if (document.hidden) return;
        if (gameState.income > 0) {
          gameState.balance += gameState.income / loopDivider;
          updateUI();
        }
      }, loopInterval);

      saveLoopInterval = setInterval(() => saveGame(true), 5000);
      bootFirebaseConnections();
    });

    window.addEventListener('load', () => {
      const loader = document.getElementById('loading-screen');
      if (!loader) return;
      loader.style.opacity = '0';
      setTimeout(() => loader.remove(), 520);
    });

    document.addEventListener('visibilitychange', () => {
      if (isResetting) return;
      if (!document.hidden) return;
      saveGame(true);
    });

    window.addEventListener('pagehide', () => {
      if (isResetting) return;
      saveGame(true);
      if (leaderboardPublishTimer) {
        clearTimeout(leaderboardPublishTimer);
        leaderboardPublishTimer = null;
      }
      if (leaderboardDirty) syncScoreToFirestore(true).catch(() => {});
    });

    window.addEventListener('beforeunload', () => {
      if (isResetting) return;
      saveGame(true);

      const sessionLength = Math.floor((Date.now() - sessionStart) / 1000);
      if (typeof trackEvent === 'function') {
        trackEvent('Engagement', 'session_length', sessionLength);
      }

      if (gameLoopInterval) {
        clearInterval(gameLoopInterval);
        gameLoopInterval = null;
      }
      if (saveLoopInterval) {
        clearInterval(saveLoopInterval);
        saveLoopInterval = null;
      }
      if (leaderboardSyncInterval) {
        clearInterval(leaderboardSyncInterval);
        leaderboardSyncInterval = null;
      }
      if (leaderboardPublishTimer) {
        clearTimeout(leaderboardPublishTimer);
        leaderboardPublishTimer = null;
      }
      stopLeaderboardPolling();

      try {
        if (window.__FIREBASE__ && leaderboardDirty) syncScoreToFirestore(true);
      } catch {}
    });
  </script>
</body>
</html>
